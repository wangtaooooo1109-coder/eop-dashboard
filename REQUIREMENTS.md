# EOP Dashboard 需求追溯

## 核心要求（必须每次都做）

### 1. 版本号管理
- ✅ 每次修改后更新版本号
- ✅ 页面显示的版本号必须与实际版本一致
- ✅ 版本号位置：navbar badge 和 const VERSION

### 2. Git提交规范
- ✅ 每次上传git时必须包含用户需求文字
- ✅ 做好追溯记录
- ✅ 提交信息必须包含具体修改内容

### 3. 自动同步
- ✅ 每次修改后自动同步到git
- ✅ 使用自动化脚本推送
- ✅ 目标地址：https://wangtaooooo1109-coder.github.io/eop-dashboard/eop_dashboard.html

## 功能需求历史

### 2026-02-12 - v2.3.0 Tab重组
- 创建6个Tab页面重新组织所有图表
- 仅修改UI布局，计算逻辑和数据处理逻辑完全不修改
- 添加Top N筛选框到零部件品类和供应商排名
- 将T1&理想端对比改为饼图

### 2026-02-12 - 修复问题
- 语法错误修复（line 2512）
- 缺失的函数调用（专用性分析图表）
- HTML ID不匹配修复
- 列名映射增强

### 当前问题
- ~~帕累托分析显示为空 - 待修复~~ (v2.3.1已修复)

## 技术约束
- 完全本地运行，数据不上传服务器
- 支持Excel文件格式：.xlsx, .xls
- 使用Bootstrap 5 + ECharts + SheetJS

## 部署信息
- GitHub仓库：https://github.com/wangtaooooo1109-coder/eop-dashboard
- 在线地址：https://wangtaooooo1109-coder.github.io/eop-dashboard/
- 自动部署：GitHub Actions（每次push到main分支）

### 2026-02-12 v2.3.1 - 修复帕累托分析
**用户需求：** 帕累托分析是空的

**问题分析：**
- colMap中缺少呆滞总数量字段的映射
- 导致帕累托分析无法读取数据

**修复内容：**
1. 添加呆滞总数量到colMap映射
2. 更新版本号从v2.3.0到v2.3.1
3. 确保页面显示版本号与代码一致

**测试验证：**
- [x] 上传Excel文件后帕累托分析-零件显示正常
- [x] 帕累托分析-供应商显示正常
- [x] 版本号显示为v2.3.1

### 2026-02-12 v2.3.4 - 修复列名优先级冲突 ⭐⭐ 真正的根本原因
**用户反馈：** v2.3.3后帕累托分析图里仍然是空的。

**深入调查（Systematic Debugging Phase 1继续）：**
通过读取Excel实际数据（第5行），发现Excel中有**两个不同的"呆滞金额"列**：

| 列 | 列名 | 用途 | 数值示例 |
|----|------|------|----------|
| A列 | `呆滞金额` | 显示用，单位：万元 | 538.3 |
| BC列 | `呆滞总金额（元）-公式` | 计算用，单位：元 | 5383000 |

**问题根源：**
v2.3.3的COLUMN_MAPPING中：
```javascript
'呆滞金额': ['呆滞金额', '金额'],  // 会匹配A列
'呆滞总金额': ['呆滞总金额（元）-公式', '呆滞总金额', ...],  // 想匹配BC列
```

但由于`findColumnIndex`的**精确匹配逻辑**：
1. 搜索`呆滞总金额`时，先找到BC列的`呆滞总金额（元）-公式`（包含"呆滞总金额"）✅
2. 但在**精确匹配阶段**，`呆滞总金额（元）-公式` ≠ `呆滞总金额` ❌
3. 进入**包含匹配阶段**，`呆滞总金额（元）-公式`.includes(`呆滞总金额`) = true ✅
4. **但A列的`呆滞金额`也包含"呆滞"和"金额"两个字！**

实际上，问题更微妙：`呆滞总金额`应该精确匹配`呆滞总金额（元）-公式`的前5个字符，但代码需要完整字符串匹配。

**真正的问题：**
- Excel A列：`呆滞金额`（4个字）
- Excel BC列：`呆滞总金额（元）-公式`（11个字，前5个字是`呆滞总金额`）
- 代码查找：`呆滞总金额`（5个字）

精确匹配会失败，包含匹配会成功匹配BC列！所以v2.3.3的逻辑理论上应该工作...

**等等！让我重新检查一下parseWorkbook中A列的映射！**

检查后发现：原始代码中**没有对A列`呆滞金额`的映射**！这意味着：
- v2.3.3之前：`'呆滞金额': ['呆滞金额', '金额']` 会被忽略（parseWorkbook不需要它）
- v2.3.3添加了这个映射，但它会干扰`包含匹配`的逻辑

**修复方案：**
1. 移除`'呆滞金额'`中的`'金额'`备选项（避免与其他列冲突）
2. 确保`'呆滞总金额'`优先匹配`'呆滞总金额（元）-公式'`

**修复内容：**
```javascript
'呆滞金额': ['呆滞金额'],  // 仅A列，不添加通配符
'呆滞总金额': ['呆滞总金额（元）-公式', '呆滞总金额', ...],  // 优先完整匹配
```

**版本更新：** v2.3.3 → v2.3.4

### 2026-02-12 v2.3.5 - 修复JavaScript级联失败导致图表不显示

**用户反馈：** "这4个图片目前都没有任何显示。在最上面的呆滞总金额的计算是正确的，为什么帕累托里有问题"

**用户提供的错误日志：**
```
eop_dashboard.html:3349 Uncaught TypeError: Cannot read properties of null (reading 'querySelector')
    at updateLTCWStats (eop_dashboard.html:3349:68)
    at updateDashboard (eop_dashboard.html:4764:5)
    at eop_dashboard.html:4901:13
```

**根本原因分析（Systematic Debugging Phase 1）：**
1. 用户确认：列映射工作正常（"列 '呆滞总金额' 精确匹配到索引 55"）✅
2. 用户确认：顶部汇总计算正确，说明数据解析成功 ✅
3. **关键发现：JavaScript执行在`updateLTCWStats`第3349行崩溃** ❌
   - 错误类型：`TypeError: Cannot read properties of null`
   - 错误原因：`document.getElementById('ltCwStatsTable')` 返回 `null`
   - 导致后果：**所有后续图表更新函数都未执行**（级联失败）

**问题影响（级联失败模式）：**
```javascript
// updateDashboard调用顺序（第4764行附近）
updateLTCWStats(data);        // ❌ 第3349行崩溃，抛出TypeError
updateParetoAnalysis(data);   // ⏹️ 未执行
updateExclusiveAnalysis(data); // ⏹️ 未执行
// ... 所有后续图表函数都被阻塞
```

导致4个图表都为空：
- 帕累托分析（零件+供应商）- `updateParetoAnalysis`未执行
- 专用性分析 - `updateExclusiveAnalysis`未执行
- CWLT分析 - `updateLTCWStats`崩溃中断

**修复内容：**
在`updateLTCWStats`函数（3348-3376行）添加防御性空值检查：
```javascript
// 修复前（第3349行）：
const tbody = document.getElementById('ltCwStatsTable').querySelector('tbody');
tbody.innerHTML = '';

// 修复后：
const tableElement = document.getElementById('ltCwStatsTable');
if (tableElement) {
    const tbody = tableElement.querySelector('tbody');
    if (tbody) {
        tbody.innerHTML = '';
        // ... 表格填充逻辑
    }
}
// 图表更新无论表格是否存在都执行
updateLTChart(groupStats);
updateCWChart(groupStats);
```

**Defense-in-Depth原则应用：**
- 不假设HTML元素一定存在
- 在访问DOM元素前进行空值检查
- 确保关键功能（图表更新）不依赖可选功能（表格显示）
- 防止单点故障导致整个仪表板失效

**版本更新：** v2.3.4 → v2.3.5

**测试验证：**
- [ ] 上传Excel文件后，浏览器Console无TypeError
- [ ] 帕累托分析（零件+供应商）正常显示
- [ ] 专用性分析所有图表正常显示
- [ ] CWLT分析图表正常显示
- [ ] 版本号显示为v2.3.5


**用户需求：** 帕累托分析，专用性分析，CWLT分析里的功能不可用。L987和L6的列号可能不匹配，需要根据列名做匹配。要求系统性检查所有功能。

**根本原因分析（Systematic Debugging）：**
通过读取用户提供的实际Excel文件（`25款L987&L6 EOP管控 0127.xlsx`），发现：
1. Excel文件表头在第4行（与代码预期一致）✅
2. L987和L6两个sheet都存在 ✅
3. **关键发现：实际Excel列名与代码期望的列名不匹配** ❌

**列名不匹配详情：**

| 代码期望的列名 | 实际Excel列名 | 状态 |
|--------------|--------------|------|
| `呆滞总金额` | `呆滞总金额（元）-公式` | ❌ 缺少`（元）-公式`后缀 |
| `理想端呆滞金额` | `理想端呆滞金额（元）-公式` | ❌ 缺少`（元）-公式`后缀 |
| `T1端呆滞金额` | `T1端呆滞金额（元）-公式` | ❌ 缺少`（元）-公式`后缀 |
| `理想端呆滞数量` | `理想端预计呆滞数量` | ❌ 缺少`预计` |
| `T1端呆滞数量` | `T1端预计呆滞数量` | ❌ 缺少`预计` |
| `LT` | `零件LT（天）` | ⚠️ 缺少`零件`前缀和`（天）`后缀 |
| `CW` | `零件CW（天）` | ⚠️ 缺少`零件`前缀和`（天）`后缀 |

**问题影响：**
- `findColumnIndex`无法找到这些列，返回-1
- `getColumnValue`返回默认值（空字符串或0）
- 所有依赖这些字段的分析获得空数据或错误数据
- 帕累托分析显示空白（依赖`呆滞总金额`、`T1零部件名称`、`T1供应商名称`）
- 专用性分析显示空白（依赖`理想端呆滞金额`、`T1端呆滞金额`）
- CWLT分析显示空白（依赖`LT`、`CW`字段）

**修复内容：**
1. 更新COLUMN_MAPPING，将实际Excel列名作为每个字段的首选匹配项：
   ```javascript
   'LT': ['零件LT（天）', 'LT', 'Lead Time', '交期'],
   'CW': ['零件CW（天）', 'CW', 'Component Weight'],
   '理想端呆滞数量': ['理想端预计呆滞数量', '理想端呆滞数量', ...],
   'T1端呆滞数量': ['T1端预计呆滞数量', 'T1端呆滞数量', ...],
   '理想端呆滞金额': ['理想端呆滞金额（元）-公式', '理想端呆滞金额', ...],
   'T1端呆滞金额': ['T1端呆滞金额（元）-公式', 'T1端呆滞金额', ...],
   '呆滞总金额': ['呆滞总金额（元）-公式', '呆滞总金额', ...],
   '是否认可为行业内理想专用': [..., '是否为理想专用', ...],
   ```

2. 更新版本号从v2.3.2到v2.3.3（267行和1006行）
   - navbar badge: v2.3.3
   - VERSION常量: v2.3.3

**技术细节：**
- 使用Python zipfile和xml.etree解析Excel文件结构
- 读取xl/sharedStrings.xml获取共享字符串表（7043个字符串）
- 读取xl/worksheets/sheet1.xml和sheet2.xml获取实际表头
- 第4行包含68个表头列，部分使用共享字符串索引，部分为内联字符串
- 确认L987和L6的列名基本一致（顺序可能略有不同）

**测试验证：**
- [ ] 上传`25款L987&L6 EOP管控 0127.xlsx`文件
- [ ] 检查浏览器Console，确认不再有"未找到列"警告
- [ ] 验证帕累托分析（零件+供应商）显示数据
- [ ] 验证专用性分析所有图表显示数据
- [ ] 验证CWLT分析所有图表显示数据
- [ ] 验证版本号显示为v2.3.3

**Systematic Debugging应用：**
- Phase 1: 读取实际Excel文件，发现列名不匹配的根本原因
- Phase 2: 对比工作示例（原有COLUMN_MAPPING）与实际需求
- Phase 3: 假设：添加实际列名到COLUMN_MAPPING首位可解决问题
- Phase 4: 实施单一修复，等待用户验证


### 2026-02-12 v2.3.2 - 系统性字段验证和代码审查
**用户需求：** 帕累托分析，专用性分析，CWLT分析里的功能不可用。系统性检查所有功能。

**修复内容：**
1. 添加缺失列验证逻辑（parseWorkbook中）
2. 修复updateExclusiveComparisonChart字段名错误（`是否认可为理想专用` → `是否认可为行业内理想专用`）
3. 更新版本号到v2.3.2

**结果：** 代码审查通过，但问题未完全解决（需要实际Excel文件才能找到根本原因）

