<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOP呆滞管控数据看板</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
            font-weight: bold;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .chart-container {
            height: 400px;
            padding: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
            z-index: 10;
            position: relative;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            max-height: 500px;
            overflow-y: auto;
        }

        .table {
            font-size: 0.85rem;
        }

        .table thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        .badge-custom {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
        }

        .dashboard-hidden {
            display: none;
        }

        .tier-filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }

        .tier-checkbox {
            margin-right: 5px;
        }

        .tier-checkbox-label {
            font-weight: normal;
            cursor: pointer;
            user-select: none;
        }

        /* 新增样式 - 预警列表 */
        .alert-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .alert-list .alert {
            padding: 8px 10px;
            margin-bottom: 8px;
        }

        .alert-list .alert:last-child {
            margin-bottom: 0;
        }

        /* 数据表格样式优化 */
        .data-table {
            max-height: 500px;
            overflow-y: auto;
        }

        .data-table table thead {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .data-table table th {
            cursor: pointer;
            user-select: none;
        }

        .data-table table th:hover {
            background: #f0f0f0;
        }

        /* KPI卡片增强 */
        .stat-card .stat-value {
            font-size: 1.8rem;
        }

        .stat-card small {
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* 可点击图表提示 */
        .chart-container.clickable {
            cursor: pointer;
        }

        .chart-container.clickable:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> EOP呆滞管控数据看板系统
                <span class="badge bg-light text-dark ms-2" id="versionBadge">v2.3.11</span>
                <span class="badge bg-info text-dark ms-2" id="filenameBadge" style="display: none;"></span>
            </span>
            <span class="text-white">
                <i class="fas fa-cog"></i> 可自定义分析看板
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4" id="app">
        <!-- 上传区域 -->
        <div class="row" id="uploadSection">
            <div class="col-12">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                    <h3>上传Excel文件</h3>
                    <p class="text-muted">拖拽文件到此处，或点击选择文件</p>
                    <p class="text-muted small">支持格式: .xlsx, .xls</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> 选择文件
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载动画 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h4>正在解析数据...</h4>
        </div>

        <!-- 仪表板区域 -->
        <div id="dashboard" class="dashboard-hidden">
            <!-- 配置面板 -->
            <div class="row">
                <div class="col-12">
                    <div class="config-panel">
                        <h5><i class="fas fa-sliders-h"></i> 看板配置</h5>
                        <div class="row">
                            <div class="col-md-2 config-item">
                                <label>选择工作表</label>
                                <select class="form-select" id="sheetSelector" onchange="changeSheet()">
                                    <option value="L987">L987</option>
                                    <option value="L6">L6</option>
                                    <option value="ALL">全部合并</option>
                                </select>
                            </div>
                            <div class="col-md-2 config-item">
                                <label>统计维度</label>
                                <select class="form-select" id="metricSelector" onchange="updateDashboard()">
                                    <option value="amount">呆滞金额</option>
                                    <option value="quantity">呆滞数量</option>
                                </select>
                            </div>
                            <div class="col-md-2 config-item">
                                <label>阶梯筛选（可多选）</label>
                                <div class="tier-filter-group">
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="tier-checkbox" value="50万以内" onchange="updateDashboard()"> 50万以内
                                    </label>
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="tier-checkbox" value="50-100万" onchange="updateDashboard()"> 50-100万
                                    </label>
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="tier-checkbox" value="100-500万" onchange="updateDashboard()"> 100-500万
                                    </label>
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="tier-checkbox" value="500万以上" onchange="updateDashboard()"> 500万以上
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2 config-item">
                                <label>类型筛选（可多选）</label>
                                <div class="tier-filter-group">
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="type-checkbox" value="总成" onchange="updateDashboard()"> 总成
                                    </label>
                                    <label class="tier-checkbox-label">
                                        <input type="checkbox" class="type-checkbox" value="物料" onchange="updateDashboard()"> 物料
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-1 config-item">
                                <label>Top N</label>
                                <select class="form-select" id="topN" onchange="updateDashboard()">
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="30">30</option>
                                </select>
                            </div>
                            <div class="col-md-3 config-item">
                                <label>操作</label>
                                <div>
                                    <button class="btn btn-primary btn-sm" onclick="updateDashboard()">
                                        <i class="fas fa-sync"></i> 刷新看板
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel"></i> 导出Excel
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="exportToPDF()">
                                        <i class="fas fa-file-pdf"></i> 导出PDF
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="resetFilters()">
                                        <i class="fas fa-redo"></i> 重置筛选
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 关键指标卡片 -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                        <div class="stat-label">总记录数</div>
                        <div class="stat-value" id="totalRecords">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-coins fa-2x text-success mb-2"></i>
                        <div class="stat-label">呆滞总金额</div>
                        <div class="stat-value" id="totalAmount">¥0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-industry fa-2x text-warning mb-2"></i>
                        <div class="stat-label">T1端金额</div>
                        <div class="stat-value" id="t1Amount">¥0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="fas fa-building fa-2x text-info mb-2"></i>
                        <div class="stat-label">理想端金额</div>
                        <div class="stat-value" id="idealAmount">¥0</div>
                    </div>
                </div>
            </div>

            <!-- 扩展KPI卡片 - 第二行 -->
            <div class="row">
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                        <div class="stat-label">呆滞总数量</div>
                        <div class="stat-value" id="totalQuantity">0件</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                        <div class="stat-label">平均单价</div>
                        <div class="stat-value" id="avgPrice">¥0</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-truck fa-2x text-warning mb-2"></i>
                        <div class="stat-label">供应商总数</div>
                        <div class="stat-value" id="supplierCount">0</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                        <div class="stat-label">高风险项</div>
                        <div class="stat-value" id="highRiskCount">0</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-tasks fa-2x text-info mb-2"></i>
                        <div class="stat-label">待处理措施</div>
                        <div class="stat-value" id="pendingActions">0</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <div class="stat-label">EOP零件数</div>
                        <div class="stat-value" id="eopCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Tab 导航 -->
            <div class="row mt-4">
                <div class="col-12">
                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="comprehensive-tab" data-bs-toggle="tab" data-bs-target="#comprehensive" type="button" role="tab">
                                <i class="fas fa-chart-pie"></i> 综合分析
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="supplier-tab" data-bs-toggle="tab" data-bs-target="#supplier" type="button" role="tab">
                                <i class="fas fa-truck"></i> 供应商分析
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ltcw-tab" data-bs-toggle="tab" data-bs-target="#ltcw" type="button" role="tab">
                                <i class="fas fa-chart-bar"></i> LT&CW分析
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exclusive-tab" data-bs-toggle="tab" data-bs-target="#exclusive" type="button" role="tab">
                                <i class="fas fa-lock"></i> 专用性分析
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button" role="tab">
                                <i class="fas fa-tasks"></i> 进度跟进
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="verification-tab" data-bs-toggle="tab" data-bs-target="#verification" type="button" role="tab">
                                <i class="fas fa-check-circle"></i> 数据正确性确认
                            </button>
                        </li>
                    </ul>
                                            <div class="tab-content" id="dashboardTabsContent" style="margin-top: 20px;">
                        <!-- Tab 1: 综合分析 -->
                        <div class="tab-pane fade show active" id="comprehensive" role="tabpanel">
                            <!-- 帕累托分析 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-line"></i> 帕累托分析 - 零件
                                        </div>
                                        <div class="card-body">
                                            <div id="paretoPartChart" class="chart-container"></div>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i>
                                                <span id="paretoPartInfo">前20%零件占总金额的__%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-line"></i> 帕累托分析 - 供应商
                                        </div>
                                        <div class="card-body">
                                            <div id="paretoSupplierChart" class="chart-container"></div>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i>
                                                <span id="paretoSupplierInfo">前20%供应商占总金额的__%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 呆滞金额阶梯分布、PSM专业组、零件类型 -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-layer-group"></i> 呆滞金额阶梯分布
                                        </div>
                                        <div class="card-body">
                                            <div id="tierChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-project-diagram"></i> PSM专业组分析
                                        </div>
                                        <div class="card-body">
                                            <div id="groupChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-box"></i> 零件类型分布
                                        </div>
                                        <div class="card-body">
                                            <div id="typeChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 零部件品类（带筛选） -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-cubes"></i> 零部件品类分布
                                            <div class="float-end">
                                                <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="categoryTopSelect" onchange="updateCategoryChartFromSelect()">
                                                    <option value="10">Top 10</option>
                                                    <option value="15">Top 15</option>
                                                    <option value="20">Top 20</option>
                                                    <option value="50">Top 50</option>
                                                    <option value="all">全部</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="categoryChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- T1&理想端对比（改为饼图） -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-balance-scale"></i> T1端 vs 理想端对比
                                        </div>
                                        <div class="card-body">
                                            <div id="comparisonChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 1: 综合分析 -->

                        <!-- Tab 2: 供应商分析 -->
                        <div class="tab-pane fade" id="supplier" role="tabpanel">
                            <!-- 供应商呆滞金额排名（带筛选和占比） -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-trophy"></i> 供应商呆滞金额排名
                                            <div class="float-end">
                                                <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="supplierTopSelect" onchange="updateSupplierRankingChart()">
                                                    <option value="10">Top 10</option>
                                                    <option value="15">Top 15</option>
                                                    <option value="20">Top 20</option>
                                                    <option value="30">Top 30</option>
                                                    <option value="50">Top 50</option>
                                                    <option value="all">全部</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="supplierChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 供应商集中度分析 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-pie"></i> 供应商集中度分析（Top10占比）
                                        </div>
                                        <div class="card-body">
                                            <div id="supplierConcentrationChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 2: 供应商分析 -->

                        <!-- Tab 3: LT&CW分析 -->
                        <div class="tab-pane fade" id="ltcw" role="tabpanel">
                            <!-- LT和CW交互查询 -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-search"></i> LT & CW 交互查询
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>选择PSM专业组</label>
                                                    <select class="form-select" id="ltcwQueryPSM" onchange="updateLTCWQueryParts()">
                                                        <option value="">--请选择--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>选择零件</label>
                                                    <select class="form-select" id="ltcwQueryPart" onchange="updateLTCWPartDetail()">
                                                        <option value="">--全部零件--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label>LT & CW 统计</label>
                                                    <div class="alert alert-info mb-0" id="ltcwQueryStats">
                                                        请选择PSM专业组
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <h6 class="text-center">LT分布</h6>
                                                    <div id="ltcwQueryChartLT" class="chart-container" style="height: 400px;"></div>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-12">
                                                    <h6 class="text-center">CW分布</h6>
                                                    <div id="ltcwQueryChartCW" class="chart-container" style="height: 400px;"></div>
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <div style="max-height: 300px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped" id="ltcwPartsTable">
                                                            <thead>
                                                                <tr>
                                                                    <th>零部件名称</th>
                                                                    <th>物料编码</th>
                                                                    <th>供应商</th>
                                                                    <th>LT</th>
                                                                    <th>CW</th>
                                                                    <th>呆滞金额</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- LT和CW统计分析 -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-bar"></i> LT & CW 统计分析
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>统计维度</label>
                                                    <select class="form-select" id="ltcwStatsDimension" onchange="updateLTCWStats()">
                                                        <option value="category">按零部件品类</option>
                                                        <option value="PSM">按PSM专业组</option>
                                                        <option value="categoryAndPSM">品类-PSM交叉分析</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>PSM专业组</label>
                                                    <select class="form-select" id="ltcwStatsPSM" onchange="updateLTCWRadios()">
                                                        <option value="">--全部--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label>显示内容</label>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="showLtAvg" onchange="updateLTCWStats()" checked>
                                                        <label class="form-check-label" for="showLtAvg">LT平均值</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="showCwAvg" onchange="updateLTCWStats()" checked>
                                                        <label class="form-check-label" for="showCwAvg">CW平均值</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-center">LT统计</h6>
                                                    <div id="ltStatsChart" class="chart-container"></div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-center">CW统计</h6>
                                                    <div id="cwStatsChart" class="chart-container"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CW/LT 分布图分析 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-area"></i> CW/LT 分布图分析
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>PSM专业组</label>
                                                    <select class="form-select" id="distPSM" onchange="updateDistParts(); updateDistributionAnalysis()">
                                                        <option value="">--全部--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>零件</label>
                                                    <select class="form-select" id="distPart" onchange="updateDistributionAnalysis()">
                                                        <option value="">--全部--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <label>LT范围(月)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control form-control-sm" id="distLTMin" placeholder="0" onchange="updateDistributionAnalysis()">
                                                        <span class="input-group-text">-</span>
                                                        <input type="number" class="form-control form-control-sm" id="distLTMax" placeholder="100" onchange="updateDistributionAnalysis()">
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <label>CW范围(月)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control form-control-sm" id="distCWMin" placeholder="0" onchange="updateDistributionAnalysis()">
                                                        <span class="input-group-text">-</span>
                                                        <input type="number" class="form-control form-control-sm" id="distCWMax" placeholder="100" onchange="updateDistributionAnalysis()">
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <label>操作</label>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="checkbox" id="showDistTable" onchange="updateDistributionAnalysis()">
                                                        <label class="form-check-label" for="showDistTable">显示明细</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="distSummary" class="alert alert-info mb-3">筛选结果：...</div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-center">LT分布（按2周区间）</h6>
                                                    <div id="distChartLT" class="chart-container" style="height: 400px;"></div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-center">CW分布（按2周区间）</h6>
                                                    <div id="distChartCW" class="chart-container" style="height: 400px;"></div>
                                                </div>
                                            </div>
                                            <div class="row mt-3" id="distTableContainer" style="display: none;">
                                                <div class="col-12">
                                                    <h6>明细列表（可点击排序）</h6>
                                                    <div style="max-height: 400px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped table-hover" id="distTable">
                                                            <thead class="sticky-top bg-white">
                                                                <tr>
                                                                    <th style="cursor: pointer;" onclick="sortDistTable('part')">零部件名称</th>
                                                                    <th style="cursor: pointer;" onclick="sortDistTable('lt')">LT(月)</th>
                                                                    <th style="cursor: pointer;" onclick="sortDistTable('cw')">CW(月)</th>
                                                                    <th style="cursor: pointer;" onclick="sortDistTable('amount')">呆滞金额</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 3: LT&CW分析 -->

                        <!-- Tab 4: 专用性分析 -->
                        <div class="tab-pane fade" id="exclusive" role="tabpanel">
                            <!-- 是否认可理想专用 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-check-circle"></i> 是否认可为理想专用
                                        </div>
                                        <div class="card-body">
                                            <div id="idealExclusiveChart" class="chart-container" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 专用性多维度分析 -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-project-diagram"></i> 按PSM专业组的专用性分布
                                        </div>
                                        <div class="card-body">
                                            <div id="exclusivityMultiChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-pie"></i> 专用性饼图分布
                                        </div>
                                        <div class="card-body">
                                            <div id="exclusivityPieChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 专用件金额对比 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-balance-scale"></i> 专用 vs 非专用金额对比
                                        </div>
                                        <div class="card-body">
                                            <div id="exclusiveComparisonChart" class="chart-container"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 专用零件交互查询 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-search"></i> 专用零件交互查询
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <label>选择PSM专业组</label>
                                                    <select class="form-select" id="exclusiveQueryPSM" onchange="updateExclusiveQueryParts()">
                                                        <option value="">--请选择--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label>选择零件</label>
                                                    <select class="form-select" id="exclusiveQueryPart" onchange="updateExclusivePartDetail()">
                                                        <option value="">--全部零件--</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label>专用零件统计</label>
                                                    <div class="alert alert-info mb-0" id="exclusiveQueryStats">
                                                        请选择PSM专业组
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div style="max-height: 300px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped" id="exclusivePartsTable">
                                                            <thead>
                                                                <tr>
                                                                    <th>零部件名称</th>
                                                                    <th>物料编码</th>
                                                                    <th>供应商</th>
                                                                    <th>呆滞金额</th>
                                                                    <th>是否认可理想专用</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 4: 专用性分析 -->

                        <!-- Tab 5: 进度跟进 -->
                        <div class="tab-pane fade" id="progress" role="tabpanel">
                            <!-- Review状态分析 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-tasks"></i> Review状态分析
                                        </div>
                                        <div class="card-body">
                                            <div id="reviewChart" class="chart-container" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 下一步措施分析 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-clipboard-list"></i> 下一步措施分类统计
                                        </div>
                                        <div class="card-body">
                                            <div id="nextStepChart" class="chart-container" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 5: 进度跟进 -->

                        <!-- Tab 6: 数据正确性确认 -->
                        <div class="tab-pane fade" id="verification" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-dollar-sign"></i> 单价合理性确认进度
                                        </div>
                                        <div class="card-body">
                                            <div id="priceReasonableChart" class="chart-container" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-clock"></i> CW/LT合理性确认进度
                                        </div>
                                        <div class="card-body">
                                            <div id="cwReasonableChart" class="chart-container" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Tab 6: 数据正确性确认 -->

                    </div>                </div>
            </div>
            <!-- End Tab 导航 -->

        </div>
    </div>

    <!-- 依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // 版本号
        const VERSION = 'v2.3.11';

        // CW中品类参考标准数据（天数）
        const CW_STANDARDS = [
{"大类":"无机非金属材料","中品类":"碳材料","小类":"石墨、增碳剂、碳纤维","进口CW":60,"国产CW":60},
{"大类":null,"中品类":"玻璃","小类":"车窗、天窗、玻璃盖板","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"陶瓷制品","小类":"陶瓷棒、传统陶瓷、结构陶瓷、功能陶瓷、搪瓷","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"多元素组合物质","小类":"氧化物，碳化物等，碳酸钡、氧化铅、钛白粉，多元素催化剂","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"人工晶体","小类":"人工水晶，人工金刚石，装饰用晶石","进口CW":90,"国产CW":60},
{"大类":"金属材料","中品类":"金属标准件","小类":"螺钉、螺母等金属标准件","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"磁性材料","小类":"铁氧永磁体、磁钢","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"钢铁制品","小类":"钢板/钢丝/钢管/其他钢铁制品，金属包装等","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"铝制品","小类":"轮毂，盖板，后门背板，前地板、壳体类、支架类、挤出件等","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"锡制品","小类":"锡膏、锡丝等","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"铜制品","小类":"铜、含铜制品","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"贵金属制品","小类":"金、银、铂等","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"稀有金属制品","小类":"钯、铑、镍、钴等，或者金属催化剂","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"合金材料","小类":"钢合金、铝合金等合金材料","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"机加工制品","小类":"高精度齿轴、轴承、金属管路等","进口CW":90,"国产CW":60},
{"大类":null,"中品类":"压铸制品","小类":"车门板、翼子板等冲压大件","进口CW":null,"国产CW":60},
{"大类":"高分子材料","中品类":"塑料/橡胶标准件","小类":"橡胶塑料标准件（硅胶垫片）","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"塑料","小类":"仪表板、保险杠、塑料保护膜，包装类等塑料和树脂类产品","进口CW":75,"国产CW":55},
{"大类":null,"中品类":"橡胶","小类":"轮胎，密封圈，密封条，垫片等橡胶制品","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"固化剂","小类":"固化剂/胶水，固体胶，双面胶，胶带","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"油脂类","小类":"润滑油，黄油，润滑剂等","进口CW":null,"国产CW":45},
{"大类":null,"中品类":"涂料液体类","小类":"油漆、油墨、油/水性清洗溶剂、清洁剂、稀释剂等，电泳液，电镀液等","进口CW":null,"国产CW":30},
{"大类":null,"中品类":"纺织纤维","小类":"地毯，纺织品，顶棚等纤维类产品","进口CW":null,"国产CW":30},
{"大类":null,"中品类":"加工纸制品","小类":"纸质标签、纸质包装等","进口CW":null,"国产CW":30},
{"大类":null,"中品类":"木质材料","小类":"天然木材，合成木材等","进口CW":null,"国产CW":30},
{"大类":null,"中品类":"海绵制品","小类":"海绵、吸音绵、泡绵、珍珠绵包材","进口CW":null,"国产CW":21},
{"大类":"复合材料","中品类":"线束连接器","小类":"端子、防水栓、护套","进口CW":120,"国产CW":56},
{"大类":null,"中品类":"线束附件","小类":"卡扣、扎带、橡胶件、支架、波纹管","进口CW":56,"国产CW":30},
{"大类":null,"中品类":"线束天线类","小类":"5G/射频天线等","进口CW":90,"国产CW":21},
{"大类":null,"中品类":"PCB","小类":"PCB","进口CW":null,"国产CW":60},
{"大类":null,"中品类":"继电器","小类":"继电器","进口CW":90,"国产CW":null},
{"大类":null,"中品类":"皮质类","小类":"座椅覆面，方向盘材质","进口CW":105,"国产CW":90},
{"大类":null,"中品类":"脱模剂","小类":"脱模剂","进口CW":null,"国产CW":30},
{"大类":"高价值组合材料","中品类":"电池类","小类":"绝缘膜、Pack、电解液、隔膜、电芯","进口CW":150,"国产CW":90},
{"大类":null,"中品类":"摄像头类","小类":"摄像头FPC","进口CW":150,"国产CW":90},
{"大类":null,"中品类":"屏幕类","小类":"屏幕模组","进口CW":150,"国产CW":90},
{"大类":null,"中品类":"阀体类","小类":"电磁阀，球阀等","进口CW":150,"国产CW":90},
{"大类":null,"中品类":"电机类","小类":"马达电机，伺服电机，转子，后视镜折叠电机","进口CW":150,"国产CW":90},
{"大类":null,"中品类":"PCBA类","小类":"PCBA半成品","进口CW":120,"国产CW":90},
{"大类":"半导体材料","中品类":"被动器件(电容/电感）","小类":"铝电解电容\n钽电容\n陶瓷电容\n电感","进口CW":120,"国产CW":60},
{"大类":null,"中品类":"电源芯片","小类":"PMIC\nSBC\nDCDC\nLDO\nVoltage Reference","进口CW":140,"国产CW":98},
{"大类":null,"中品类":"分立器件(IGBT/MOSFET)","小类":"Sic\nIGBT\nMOSFET","进口CW":140,"国产CW":60},
{"大类":null,"中品类":"传感器芯片","小类":"传感器芯片","进口CW":126,"国产CW":null},
{"大类":null,"中品类":"逻辑与模拟芯片","小类":"逻辑门/Gate\n触发器/Trigger\n寄存器\n电平转换/LevelShifter\nAFE\n放大器\n比较器\n多路数据选择器","进口CW":98,"国产CW":60},
{"大类":null,"中品类":"存储芯片","小类":"DDR\neMMC\nUFS\nNor Flash\nEEPROM","进口CW":147,"国产CW":126},
{"大类":null,"中品类":"通信芯片","小类":"SerDes\nEthernet Switch/PHY\nDaisy Chain\nCAN/CAN-FD/LIN\nA2B\nFM/DAB","进口CW":180,"国产CW":60},
{"大类":null,"中品类":"处理器","小类":"SoC\nMCU","进口CW":120,"国产CW":100},
{"大类":null,"中品类":"分立器件(二三极管/TVS)","小类":"二三极管\nTVS","进口CW":105,"国产CW":56},
{"大类":null,"中品类":"驱动与隔离芯片","小类":"Smart HSD/LSD\nMulti HSD/LSD\n全桥\n半桥\n多路半桥\nLED驱动\n火工品点爆驱动芯片\n数字隔离\n电源隔离\n隔离驱动\n隔离运放\n隔离ADC/隔离CAN","进口CW":126,"国产CW":42},
{"大类":null,"中品类":"被动器件(电阻/晶体/晶振)","小类":"电阻\n晶体/晶振","进口CW":98,"国产CW":60},
{"大类":"其他","中品类":"其他，当前品类无法覆盖","小类":"需联系对应PSM确认是否无法覆盖，然后PSM内部讨论后迭代","进口CW":null,"国产CW":null}
        ];

        // 全局数据存储
        let allData = {
            L987: [],
            L6: []
        };
        let currentSheet = 'L987';
        let charts = {};

        // ========== 安全的DOM访问辅助函数 ==========
        // v2.3.7: 统一的防御性DOM元素访问，防止访问不存在的元素导致崩溃
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`[Defense] Element not found: '${id}' - using fallback`);
            }
            return element;
        }

        function safeGetValue(id, defaultValue = '') {
            const element = safeGetElement(id);
            return element ? element.value : defaultValue;
        }

        function safeSetTextContent(id, text) {
            const element = safeGetElement(id);
            if (element) {
                element.textContent = text;
            }
        }

        function safeSetInnerHTML(id, html) {
            const element = safeGetElement(id);
            if (element) {
                element.innerHTML = html;
            }
        }

        // 列名映射（标准列名）
        const COLUMN_MAPPING = {
            '呆滞金额': ['呆滞金额'],  // A列，仅用于显示的万元汇总值
            '分类': ['分类', '呆滞分类'],
            'PSM专业组': ['PSM专业组', 'PSM组'],
            'PSM': ['PSM'],
            '零件类型': ['零件类型', '类型'],
            'T1物料编码': ['T1物料编码', '物料编码'],
            'T1零部件名称': ['T1零部件名称', '零部件名称', '零件名称'],
            'T1供应商编码': ['T1供应商编码', '供应商编码'],
            'T1供应商名称': ['T1供应商名称', '供应商名称', '供应商'],
            'Tn零部件品类': ['Tn零部件品类', '零部件品类', '品类'],
            '是否EOP': ['是否EOP', 'EOP'],
            'LT': ['零件LT（天）', 'LT', 'Lead Time', '交期'],
            'CW': ['零件CW（天）', 'CW', 'Component Weight'],
            '是否认可为行业内理想专用': ['是否认可为行业内理想专用', '是否认可为理想专用', '是否为理想专用', '理想专用'],
            '单价是否合理': ['单价是否合理', '单价合理性'],
            'CW_LT是否合理': ['CW_LT是否合理', 'CW/LT是否合理', 'CWLT是否合理'],
            '理想端呆滞数量': ['理想端预计呆滞数量', '理想端呆滞数量', '理想端数量', '理想端-呆滞数量', '理想-呆滞数量'],
            'T1端呆滞数量': ['T1端预计呆滞数量', 'T1端呆滞数量', 'T1端数量', 'T1端-呆滞数量', 'T1-呆滞数量'],
            '理想端呆滞金额': ['理想端呆滞金额（元）-公式', '理想端呆滞金额', '理想端金额', '理想端-呆滞金额', '理想-呆滞金额'],
            'T1端呆滞金额': ['T1端呆滞金额（元）-公式', 'T1端呆滞金额', 'T1端金额', 'T1端-呆滞金额', 'T1-呆滞金额'],
            '呆滞总金额': ['呆滞总金额（元）-公式', '呆滞总金额', '总金额', '呆滞金额合计'],  // 优先匹配BC列带公式的
            '呆滞总数量': ['呆滞总数量', '总数量', '呆滞数量合计', '数量'],
            '下一步措施': ['下一步措施', '措施', '处理措施'],
            '内部review': ['内部review', 'review', '审核状态', 'Review']
        };

        // 根据列名查找列索引
        function findColumnIndex(headers, fieldName) {
            const possibleNames = COLUMN_MAPPING[fieldName] || [fieldName];

            // 首先尝试精确匹配
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().trim();
                for (const name of possibleNames) {
                    if (header === name) {
                        console.log(`列 "${fieldName}" 精确匹配到索引 ${i}: ${header}`);
                        return i;
                    }
                }
            }

            // 如果没有精确匹配，尝试包含匹配（但要求完全匹配更长的优先）
            let bestMatch = { index: -1, matchLength: 0 };
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().trim();
                for (const name of possibleNames) {
                    if (header.includes(name) && name.length > bestMatch.matchLength) {
                        bestMatch = { index: i, matchLength: name.length };
                    }
                }
            }

            if (bestMatch.index !== -1) {
                console.log(`列 "${fieldName}" 部分匹配到索引 ${bestMatch.index}`);
                return bestMatch.index;
            }

            console.warn(`未找到列: ${fieldName}, 尝试的列名: ${possibleNames.join(', ')}`);
            return -1;
        }

        // 安全获取列值
        function getColumnValue(row, index, defaultValue = '') {
            if (index === -1 || index >= row.length) {
                return defaultValue;
            }
            return row[index] !== undefined && row[index] !== null ? row[index] : defaultValue;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initUploadArea();
            setupChartResize();
        });

        // 初始化上传区域
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // 处理文件选择
            fileInput.addEventListener('change', handleFileSelect);

            // 拖拽功能
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // 处理Excel文件
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('请上传Excel文件 (.xlsx 或 .xls)');
                return;
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('uploadSection').style.display = 'none';

            // 显示文件名
            const filenameBadge = document.getElementById('filenameBadge');
            filenameBadge.textContent = file.name;
            filenameBadge.style.display = 'inline-block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    parseWorkbook(workbook);

                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('dashboard').classList.remove('dashboard-hidden');

                    updateDashboard();
                } catch (error) {
                    alert('文件解析失败: ' + error.message);
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('uploadSection').style.display = 'block';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 解析工作簿
        function parseWorkbook(workbook) {
            ['L987', 'L6'].forEach(sheetName => {
                if (workbook.SheetNames.includes(sheetName)) {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    // 第4行是表头，从第5行开始是数据
                    const headers = jsonData[3];
                    const dataRows = jsonData.slice(4);

                    console.log(`${sheetName} 表头:`, headers);

                    // 建立列索引映射
                    const colMap = {
                        呆滞金额: findColumnIndex(headers, '呆滞金额'),
                        分类: findColumnIndex(headers, '分类'),
                        PSM专业组: findColumnIndex(headers, 'PSM专业组'),
                        PSM: findColumnIndex(headers, 'PSM'),
                        零件类型: findColumnIndex(headers, '零件类型'),
                        T1物料编码: findColumnIndex(headers, 'T1物料编码'),
                        T1零部件名称: findColumnIndex(headers, 'T1零部件名称'),
                        T1供应商编码: findColumnIndex(headers, 'T1供应商编码'),
                        T1供应商名称: findColumnIndex(headers, 'T1供应商名称'),
                        Tn零部件品类: findColumnIndex(headers, 'Tn零部件品类'),
                        是否EOP: findColumnIndex(headers, '是否EOP'),
                        LT: findColumnIndex(headers, 'LT'),
                        CW: findColumnIndex(headers, 'CW'),
                        是否认可为行业内理想专用: findColumnIndex(headers, '是否认可为行业内理想专用'),
                        单价是否合理: findColumnIndex(headers, '单价是否合理'),
                        CW_LT是否合理: findColumnIndex(headers, 'CW_LT是否合理'),
                        理想端呆滞数量: findColumnIndex(headers, '理想端呆滞数量'),
                        T1端呆滞数量: findColumnIndex(headers, 'T1端呆滞数量'),
                        理想端呆滞金额: findColumnIndex(headers, '理想端呆滞金额'),
                        T1端呆滞金额: findColumnIndex(headers, 'T1端呆滞金额'),
                        呆滞总金额: findColumnIndex(headers, '呆滞总金额'),
                        呆滞总数量: findColumnIndex(headers, '呆滞总数量'),
                        下一步措施: findColumnIndex(headers, '下一步措施'),
                        内部review: findColumnIndex(headers, '内部review')
                    };

                    console.log(`${sheetName} 列映射:`, colMap);

                    // 验证关键列是否找到
                    const missingColumns = [];
                    for (const [key, value] of Object.entries(colMap)) {
                        if (value === -1) {
                            missingColumns.push(key);
                        }
                    }
                    if (missingColumns.length > 0) {
                        console.warn(`${sheetName} 缺失列:`, missingColumns);
                    }

                    allData[sheetName] = dataRows.map(row => {
                        if (!row[0]) return null;

                        // 使用动态列索引读取数据
                        const ltValue = parseFloat(getColumnValue(row, colMap.LT, 0)) || 0;
                        const cwValue = parseFloat(getColumnValue(row, colMap.CW, 0)) || 0;
                        const 理想端数量 = parseFloat(getColumnValue(row, colMap.理想端呆滞数量, 0)) || 0;
                        const T1端数量 = parseFloat(getColumnValue(row, colMap.T1端呆滞数量, 0)) || 0;

                        const item = {
                            呆滞金额: getColumnValue(row, colMap.呆滞金额),
                            分类: getColumnValue(row, colMap.分类),
                            PSM专业组: getColumnValue(row, colMap.PSM专业组),
                            PSM: getColumnValue(row, colMap.PSM),
                            零件类型: getColumnValue(row, colMap.零件类型),
                            T1物料编码: getColumnValue(row, colMap.T1物料编码),
                            T1零部件名称: getColumnValue(row, colMap.T1零部件名称),
                            T1供应商编码: getColumnValue(row, colMap.T1供应商编码),
                            T1供应商名称: getColumnValue(row, colMap.T1供应商名称),
                            Tn零部件品类: getColumnValue(row, colMap.Tn零部件品类),
                            是否EOP: getColumnValue(row, colMap.是否EOP),
                            LT: ltValue / 30,  // 天转换为月
                            CW: cwValue / 30,  // 天转换为月
                            是否认可为行业内理想专用: getColumnValue(row, colMap.是否认可为行业内理想专用),
                            单价是否合理: getColumnValue(row, colMap.单价是否合理),
                            CW_LT是否合理: getColumnValue(row, colMap.CW_LT是否合理),
                            理想端呆滞数量: 理想端数量,
                            T1端呆滞数量: T1端数量,
                            理想端呆滞金额: parseFloat(getColumnValue(row, colMap.理想端呆滞金额, 0)) || 0,
                            T1端呆滞金额: parseFloat(getColumnValue(row, colMap.T1端呆滞金额, 0)) || 0,
                            呆滞总金额: parseFloat(getColumnValue(row, colMap.呆滞总金额, 0)) || 0,
                            呆滞总数量: 理想端数量 + T1端数量,
                            下一步措施: getColumnValue(row, colMap.下一步措施),
                            内部review: getColumnValue(row, colMap.内部review)
                        };

                        // 调试：输出组合灯数据
                        if (item.T1零部件名称 && item.T1零部件名称.includes('组合灯')) {
                            console.log('调试 - 组合灯数据:', {
                                名称: item.T1零部件名称,
                                'LT原始值-天': ltValue,
                                'LT转换后-月': item.LT,
                                'CW原始值-天': cwValue,
                                'CW转换后-月': item.CW
                            });
                        }

                        return item;
                    }).filter(item => item !== null);

                    console.log(`${sheetName} 解析完成，共 ${allData[sheetName].length} 条数据`);
                }
            });
        }

        // 切换工作表
        function changeSheet() {
            currentSheet = document.getElementById('sheetSelector').value;
            updateDashboard();
        }

        // 获取当前指标值（金额或数量）
        function getMetricValue(item, type = 'total') {
            const metricType = document.getElementById('metricSelector').value;
            if (metricType === 'amount') {
                switch(type) {
                    case 'total': return parseFloat(item.呆滞总金额) || 0;
                    case 't1': return parseFloat(item.T1端呆滞金额) || 0;
                    case 'ideal': return parseFloat(item.理想端呆滞金额) || 0;
                    default: return parseFloat(item.呆滞总金额) || 0;
                }
            } else {
                switch(type) {
                    case 'total': return parseFloat(item.呆滞总数量) || 0;
                    case 't1': return parseFloat(item.T1端呆滞数量) || 0;
                    case 'ideal': return parseFloat(item.理想端呆滞数量) || 0;
                    default: return parseFloat(item.呆滞总数量) || 0;
                }
            }
        }

        // 获取当前单位和格式化函数
        function getMetricConfig() {
            const metricType = document.getElementById('metricSelector').value;
            if (metricType === 'amount') {
                return {
                    unit: '万元',
                    label: '金额',
                    formatter: (val) => (val / 10000).toFixed(2),
                    displayFormatter: (val) => '¥' + (val / 10000).toFixed(2) + '万'
                };
            } else {
                return {
                    unit: '件',
                    label: '数量',
                    formatter: (val) => Math.round(val),
                    displayFormatter: (val) => Math.round(val) + '件'
                };
            }
        }

        // 更新仪表板
        function updateDashboard() {
            let data = [];

            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用阶梯筛选（多选）
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            // 应用类型筛选（总成/物料）
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            updateStatCards(data);
            updateTierChart(data);
            updateGroupChart(data);
            updateCategoryChart(data);
            updateTypeChart(data);
            updateComparisonChart(data);
            updateSupplierChart(data);
            updateReviewChart(data);
            updateNextStepChart(data);
            updateIdealExclusiveChart(data);
            updatePriceReasonableChart(data);
            updateCWReasonableChart(data);
            updateLTCWQueryPSMOptions(data);
            updateLTCWStats(data);
            updateDistributionOptions(data);
            updateCWStandardOptions(data);
            updateDataTable(data);

            // 新增图表更新
            updateParetoAnalysis(data);
            updateSupplierConcentration(data);
            updateCWLTReasonabilityAnalysis(data);

            // 专用性分析图表更新
            console.log('[DEBUG v2.3.10] 开始更新专用性分析，数据条数:', data.length);
            updateExclusiveByTypeChart(data);
            updateExclusiveByGroupChart(data);
            updateExclusiveComparisonChart(data);
            updateExclusiveQueryPSMOptions(data);

        }

        // 更新统计卡片
        function updateStatCards(data) {
            const totalRecords = data.length;
            const config = getMetricConfig();

            const totalValue = data.reduce((sum, item) => sum + getMetricValue(item, 'total'), 0);
            const t1Value = data.reduce((sum, item) => sum + getMetricValue(item, 't1'), 0);
            const idealValue = data.reduce((sum, item) => sum + getMetricValue(item, 'ideal'), 0);

            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            document.getElementById('totalAmount').textContent = config.displayFormatter(totalValue);
            document.getElementById('t1Amount').textContent = config.displayFormatter(t1Value);
            document.getElementById('idealAmount').textContent = config.displayFormatter(idealValue);

            // 新增KPI卡片数据
            // 1. 呆滞总数量
            const totalQuantity = data.reduce((sum, item) => sum + (parseFloat(item.呆滞总数量) || 0), 0);
            document.getElementById('totalQuantity').textContent = Math.round(totalQuantity).toLocaleString() + '件';

            // 2. 平均单价（呆滞总金额 / 呆滞总数量）
            const avgPrice = totalQuantity > 0 ? totalValue / totalQuantity : 0;
            document.getElementById('avgPrice').textContent = '¥' + avgPrice.toFixed(2);

            // 3. 供应商总数
            const suppliers = new Set(data.map(item => item.T1供应商名称).filter(s => s));
            document.getElementById('supplierCount').textContent = suppliers.size.toLocaleString();

            // 4. 高风险项（金额>100万 且 单价不合理或CW_LT不合理）
            const highRiskItems = data.filter(item => {
                const amount = parseFloat(item.呆滞总金额) || 0;
                const priceUnreasonable = (item.单价是否合理 || '').includes('不合理');
                const cwltUnreasonable = (item.CW_LT是否合理 || '').includes('不合理');
                return amount > 1000000 && (priceUnreasonable || cwltUnreasonable);
            });
            document.getElementById('highRiskCount').textContent = highRiskItems.length.toLocaleString();

            // 5. 待处理措施数量
            const pendingActions = data.filter(item => {
                const action = item.下一步措施 || '';
                return action.trim() !== '' && action.trim() !== '-' && action.trim() !== '无';
            });
            document.getElementById('pendingActions').textContent = pendingActions.length.toLocaleString();

            // 6. EOP零件数
            const eopCount = data.filter(item => (item.是否EOP || '').includes('是')).length;
            document.getElementById('eopCount').textContent = eopCount.toLocaleString();
        }

        // 更新阶梯分布图
        function updateTierChart(data) {
            const config = getMetricConfig();
            const tierData = {
                '50万以内': 0,
                '50-100万': 0,
                '100-500万': 0,
                '500万以上': 0
            };

            data.forEach(item => {
                const category = item.分类;
                if (tierData.hasOwnProperty(category)) {
                    tierData[category] += getMetricValue(item, 'total') || 0;
                }
            });

            const chartDom = safeGetElement('tierChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.tierChart) {
                charts.tierChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        return params[0].name + '<br/>' +
                               '金额: ¥' + (params[0].value / 10000).toFixed(2) + '万元';
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: Object.keys(tierData),
                    axisLabel: { rotate: 30 }
                },
                yAxis: {
                    type: 'value',
                    name: '金额(元)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                },
                series: [{
                    data: Object.values(tierData),
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            return '¥' + (params.value / 10000).toFixed(1) + '万';
                        }
                    }
                }]
            };

            charts.tierChart.setOption(option);
        }

        // 更新专业组图表
        function updateGroupChart(data) {
            const config = getMetricConfig();
            const groupData = {};
            data.forEach(item => {
                const group = item.PSM专业组;
                if (group) {
                    if (!groupData[group]) {
                        groupData[group] = 0;
                    }
                    groupData[group] += getMetricValue(item, 'total') || 0;
                }
            });

            const sortedGroups = Object.entries(groupData)
                .sort((a, b) => b[1] - a[1]);

            const chartDom = safeGetElement('groupChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.groupChart) {
                charts.groupChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return params.name + '<br/>' +
                               '金额: ¥' + (params.value / 10000).toFixed(2) + '万元<br/>' +
                               '占比: ' + params.percent + '%';
                    }
                },
                legend: {
                    orient: 'vertical',
                    right: '10%',
                    top: 'center'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}: {d}%'
                    },
                    data: sortedGroups.map(([name, value]) => ({
                        name: name,
                        value: value
                    }))
                }]
            };

            charts.groupChart.setOption(option);
        }

        // 更新品类图表
        function updateCategoryChart(data) {
            const config = getMetricConfig();
            const categoryData = {};
            data.forEach(item => {
                const category = item.Tn零部件品类;
                if (category) {
                    if (!categoryData[category]) {
                        categoryData[category] = 0;
                    }
                    categoryData[category] += getMetricValue(item, 'total') || 0;
                }
            });

            // Check for the new categoryTopSelect first, fall back to topN if not found
            const categoryTopSelect = document.getElementById('categoryTopSelect');
            const topN = categoryTopSelect ?
                (categoryTopSelect.value === 'all' ? 999999 : parseInt(categoryTopSelect.value)) :
                parseInt(document.getElementById('topN').value);

            const sortedCategories = Object.entries(categoryData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);

            const chartDom = safeGetElement('categoryChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.categoryChart) {
                charts.categoryChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'value',
                    name: '金额(元)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: sortedCategories.map(item => item[0]),
                    axisLabel: { interval: 0 }
                },
                series: [{
                    type: 'bar',
                    data: sortedCategories.map(item => item[1]),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(params) {
                            return '¥' + (params.value / 10000).toFixed(1) + '万';
                        }
                    }
                }]
            };

            charts.categoryChart.setOption(option);
        }

        // 新增函数：用于品类top select直接调用
        function updateCategoryChartFromSelect() {
            const data = currentSheet === 'ALL' ?
                [...allData.L987, ...allData.L6] :
                (allData[currentSheet] || []);
            const config = getMetricConfig();
            const categoryData = {};
            data.forEach(item => {
                const category = item.Tn零部件品类;
                if (category) {
                    if (!categoryData[category]) {
                        categoryData[category] = 0;
                    }
                    categoryData[category] += getMetricValue(item, 'total') || 0;
                }
            });

            // Check for the new categoryTopSelect first, fall back to topN if not found
            const categoryTopSelect = document.getElementById('categoryTopSelect');
            const topN = categoryTopSelect ?
                (categoryTopSelect.value === 'all' ? 999999 : parseInt(categoryTopSelect.value)) :
                parseInt(document.getElementById('topN').value);

            const sortedCategories = Object.entries(categoryData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);

            const chartDom = safeGetElement('categoryChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.categoryChart) {
                charts.categoryChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'value',
                    name: '金额(元)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: sortedCategories.map(item => item[0]),
                    axisLabel: { interval: 0 }
                },
                series: [{
                    type: 'bar',
                    data: sortedCategories.map(item => item[1]),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(params) {
                            return '¥' + (params.value / 10000).toFixed(1) + '万';
                        }
                    }
                }]
            };

            charts.categoryChart.setOption(option);
        }

        // 更新零件类型图表
        function updateTypeChart(data) {
            const config = getMetricConfig();
            const typeData = {};
            data.forEach(item => {
                const type = item.零件类型;
                if (type) {
                    if (!typeData[type]) {
                        typeData[type] = 0;
                    }
                    typeData[type] += getMetricValue(item, 'total') || 0;
                }
            });

            const chartDom = safeGetElement('typeChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.typeChart) {
                charts.typeChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return params.name + '<br/>' +
                               '金额: ¥' + (params.value / 10000).toFixed(2) + '万元<br/>' +
                               '占比: ' + params.percent + '%';
                    }
                },
                legend: {
                    bottom: '5%',
                    left: 'center'
                },
                series: [{
                    type: 'pie',
                    radius: ['30%', '60%'],
                    center: ['50%', '45%'],
                    data: Object.entries(typeData).map(([name, value]) => ({
                        name: name,
                        value: value
                    })),
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                }]
            };

            charts.typeChart.setOption(option);
        }

        // 更新对比图表
        function updateComparisonChart(data) {
            const config = getMetricConfig();
            const t1Total = data.reduce((sum, item) => sum + (getMetricValue(item, 't1') || 0), 0);
            const idealTotal = data.reduce((sum, item) => sum + (getMetricValue(item, 'ideal') || 0), 0);

            const chartDom = safeGetElement('comparisonChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.comparisonChart) {
                charts.comparisonChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        name: '呆滞金额对比',
                        type: 'pie',
                        radius: '60%',
                        data: [
                            {
                                value: t1Total,
                                name: 'T1端',
                                itemStyle: { color: '#667eea' }
                            },
                            {
                                value: idealTotal,
                                name: '理想端',
                                itemStyle: { color: '#764ba2' }
                            }
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        label: {
                            formatter: '{b}: {c}元 ({d}%)'
                        }
                    }
                ]
            };

            charts.comparisonChart.setOption(option);
        }

        // 更新供应商排名图表
        function updateSupplierChart(data) {
            const config = getMetricConfig();
            const supplierData = {};
            let totalAmount = 0;

            data.forEach(item => {
                const supplier = item.T1供应商名称;
                if (supplier && supplier !== '-') {
                    if (!supplierData[supplier]) {
                        supplierData[supplier] = { count: 0, amount: 0 };
                    }
                    supplierData[supplier].count += 1;
                    supplierData[supplier].amount += getMetricValue(item, 'total') || 0;
                    totalAmount += getMetricValue(item, 'total') || 0;
                }
            });

            // Check for the new supplierTopSelect first, fall back to topN if not found
            const supplierTopSelect = document.getElementById('supplierTopSelect');
            const topN = supplierTopSelect ?
                (supplierTopSelect.value === 'all' ? 999999 : parseInt(supplierTopSelect.value)) :
                parseInt(document.getElementById('topN').value);

            const sortedSuppliers = Object.entries(supplierData)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, topN);

            const chartDom = safeGetElement('supplierChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.supplierChart) {
                charts.supplierChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const supplier = params[0].name;
                        const data = supplierData[supplier];
                        const percentage = ((data.amount / totalAmount) * 100).toFixed(2);
                        return supplier + '<br/>' +
                               '呆滞金额: ¥' + (parseFloat(config.formatter(data.amount))).toFixed(2) + '万元<br/>' +
                               '占比: ' + percentage + '%<br/>' +
                               '记录数: ' + data.count + '条';
                    }
                },
                grid: { left: '3%', right: '8%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'value',
                    name: '呆滞金额(元)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                },
                yAxis: {
                    type: 'category',
                    data: sortedSuppliers.map(item => item[0]),
                    axisLabel: {
                        interval: 0,
                        formatter: function(value) {
                            return value.length > 12 ? value.substring(0, 12) + '...' : value;
                        }
                    }
                },
                series: [{
                    type: 'bar',
                    data: sortedSuppliers.map(item => item[1].amount),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#f093fb' },
                            { offset: 1, color: '#f5576c' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(params) {
                            const supplier = sortedSuppliers[params.dataIndex][0];
                            const data = supplierData[supplier];
                            const percentage = ((data.amount / totalAmount) * 100).toFixed(1);
                            return '¥' + (params.value / 10000).toFixed(1) + '万 (' + percentage + '%)';
                        }
                    }
                }]
            };

            charts.supplierChart.setOption(option);
        }

        // 新增函数：用于供应商top select直接调用
        function updateSupplierRankingChart() {
            const data = currentSheet === 'ALL' ?
                [...allData.L987, ...allData.L6] :
                (allData[currentSheet] || []);
            updateSupplierChart(data);
        }

        // 更新Review状态图表
        function updateReviewChart(data) {
            const config = getMetricConfig();
            const reviewData = {};
            data.forEach(item => {
                let review = item.内部review;
                if (!review || review.trim() === '') {
                    review = '未填写';
                }
                if (!reviewData[review]) {
                    reviewData[review] = { count: 0, amount: 0 };
                }
                reviewData[review].count += 1;
                reviewData[review].amount += getMetricValue(item, 'total') || 0;
            });

            const sortedReview = Object.entries(reviewData)
                .sort((a, b) => b[1].amount - a[1].amount);

            const chartDom = safeGetElement('reviewChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.reviewChart) {
                charts.reviewChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        // 仅显示状态，不显示备注栏内的说明
                        return params.name + ': ' + params.percent + '%';
                    }
                },
                legend: {
                    orient: 'vertical',
                    right: '5%',
                    top: 'center',
                    formatter: function(name) {
                        return name.length > 15 ? name.substring(0, 15) + '...' : name;
                    }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: function(params) {
                            return params.name.length > 10 ?
                                   params.name.substring(0, 10) + '...\n' + params.percent + '%' :
                                   params.name + '\n' + params.percent + '%';
                        }
                    },
                    data: sortedReview.map(([name, value]) => ({
                        name: name,
                        value: value.count
                    }))
                }]
            };

            charts.reviewChart.setOption(option);
        }

        // 更新下一步措施图表（支持多选项整合）
        function updateNextStepChart(data) {
            const config = getMetricConfig();
            const nextStepData = {};

            // 常见的措施选项（根据多选框）
            const stepOptions = [
                '降价',
                '改方案',
                '转EOP',
                '消化',
                '赔付',
                '其他'
            ];

            data.forEach(item => {
                let steps = item.下一步措施;

                // 空白显示为"暂未定"
                if (!steps || steps.trim() === '' || steps === '-' || steps === '无') {
                    steps = '暂未定';
                }

                // 检测可能的多选项（用逗号、分号、顿号等分隔）
                const stepList = steps.split(/[,，;；、\s]+/).filter(s => s.trim() !== '');

                if (stepList.length === 0) {
                    stepList.push('暂未定');
                }

                stepList.forEach(step => {
                    step = step.trim();

                    // 如果是"暂未定"，直接使用
                    if (step === '暂未定') {
                        if (!nextStepData['暂未定']) {
                            nextStepData['暂未定'] = { count: 0, amount: 0 };
                        }
                        nextStepData['暂未定'].count += 1;
                        nextStepData['暂未定'].amount += getMetricValue(item, 'total') || 0;
                        return;
                    }

                    // 匹配标准选项
                    let matchedStep = '其他';
                    for (const option of stepOptions) {
                        if (step.includes(option) || option.includes(step)) {
                            matchedStep = option;
                            break;
                        }
                    }

                    if (!nextStepData[matchedStep]) {
                        nextStepData[matchedStep] = { count: 0, amount: 0 };
                    }
                    nextStepData[matchedStep].count += 1;
                    nextStepData[matchedStep].amount += getMetricValue(item, 'total') || 0;
                });
            });

            const sortedSteps = Object.entries(nextStepData)
                .sort((a, b) => b[1].amount - a[1].amount);

            const chartDom = safeGetElement('nextStepChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.nextStepChart) {
                charts.nextStepChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const step = params[0].axisValue;
                        const data = nextStepData[step];
                        return step + '<br/>' +
                               '呆滞金额: ¥' + (params[0].value / 10000).toFixed(2) + '万元<br/>' +
                               '记录数: ' + data.count + '条';
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '5%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: sortedSteps.map(item => item[0]),
                    axisLabel: {
                        rotate: 0,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '呆滞金额(元)',
                    axisLabel: {
                        formatter: function(value) {
                            return (value / 10000).toFixed(0) + '万';
                        }
                    }
                },
                series: [{
                    type: 'bar',
                    data: sortedSteps.map(item => item[1].amount),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 1, 0, 0, [
                            { offset: 0, color: '#4facfe' },
                            { offset: 1, color: '#00f2fe' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            const data = nextStepData[params.name];
                            return '¥' + (params.value / 10000).toFixed(1) + '万\n(' + data.count + '条)';
                        }
                    }
                }]
            };

            charts.nextStepChart.setOption(option);
        }

        // 更新是否认可为理想专用图表
        function updateIdealExclusiveChart(data) {
            const config = getMetricConfig();
            const exclusiveData = {};
            data.forEach(item => {
                let status = item.是否认可为行业内理想专用;
                if (!status || status.trim() === '') {
                    status = '未填写';
                }
                if (!exclusiveData[status]) {
                    exclusiveData[status] = { count: 0, amount: 0 };
                }
                exclusiveData[status].count += 1;
                exclusiveData[status].amount += getMetricValue(item, 'total') || 0;
            });

            const sortedData = Object.entries(exclusiveData)
                .sort((a, b) => b[1].amount - a[1].amount);

            const chartDom = safeGetElement('idealExclusiveChart'); // v2.3.7.4
            if (!chartDom) return;
            if (!charts.idealExclusiveChart) {
                charts.idealExclusiveChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const status = params.name;
                        const data = exclusiveData[status];
                        return status + '<br/>' +
                               '呆滞金额: ¥' + (parseFloat(config.formatter(data.amount))).toFixed(2) + '万元<br/>' +
                               '记录数: ' + data.count + '条<br/>' +
                               '占比: ' + params.percent + '%';
                    }
                },
                series: [{
                    type: 'pie',
                    radius: '70%',
                    data: sortedData.map(([name, value]) => ({
                        name: name,
                        value: value.amount
                    })),
                    itemStyle: {
                        borderRadius: 5,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%'
                    }
                }]
            };

            charts.idealExclusiveChart.setOption(option);
        }

        // 更新单价合理性图表
        function updatePriceReasonableChart(data) {
            const config = getMetricConfig();
            const priceData = {};
            data.forEach(item => {
                let status = item.单价是否合理;
                if (!status || status.trim() === '') {
                    status = '未确认';
                }
                if (!priceData[status]) {
                    priceData[status] = { count: 0, amount: 0 };
                }
                priceData[status].count += 1;
                priceData[status].amount += getMetricValue(item, 'total') || 0;
            });

            const sortedData = Object.entries(priceData)
                .sort((a, b) => b[1].amount - a[1].amount);

            const chartDom = safeGetElement('priceReasonableChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.priceReasonableChart) {
                charts.priceReasonableChart = echarts.init(chartDom);
            }

            // 计算确认进度
            const total = data.length;
            const confirmed = data.filter(item => item.单价是否合理 && item.单价是否合理.trim() !== '').length;
            const progress = total > 0 ? ((confirmed / total) * 100).toFixed(1) : 0;

            const option = {
                title: {
                    text: `确认进度: ${progress}%`,
                    left: 'center',
                    top: '45%',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#667eea'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const status = params.name;
                        const data = priceData[status];
                        return status + '<br/>' +
                               '呆滞金额: ¥' + (parseFloat(config.formatter(data.amount))).toFixed(2) + '万元<br/>' +
                               '记录数: ' + data.count + '条<br/>' +
                               '占比: ' + params.percent + '%';
                    }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    data: sortedData.map(([name, value]) => ({
                        name: name,
                        value: value.amount
                    })),
                    itemStyle: {
                        borderRadius: 5,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%'
                    }
                }]
            };

            charts.priceReasonableChart.setOption(option);
        }

        // 更新CW/LT合理性图表
        function updateCWReasonableChart(data) {
            const config = getMetricConfig();
            const cwData = {};
            data.forEach(item => {
                let status = item.CW_LT是否合理;
                if (!status || status.trim() === '') {
                    status = '未确认';
                }
                if (!cwData[status]) {
                    cwData[status] = { count: 0, amount: 0 };
                }
                cwData[status].count += 1;
                cwData[status].amount += getMetricValue(item, 'total') || 0;
            });

            const sortedData = Object.entries(cwData)
                .sort((a, b) => b[1].amount - a[1].amount);

            const chartDom = safeGetElement('cwReasonableChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.cwReasonableChart) {
                charts.cwReasonableChart = echarts.init(chartDom);
            }

            // 计算确认进度
            const total = data.length;
            const confirmed = data.filter(item => item.CW_LT是否合理 && item.CW_LT是否合理.trim() !== '').length;
            const progress = total > 0 ? ((confirmed / total) * 100).toFixed(1) : 0;

            const option = {
                title: {
                    text: `确认进度: ${progress}%`,
                    left: 'center',
                    top: '45%',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#667eea'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const status = params.name;
                        const data = cwData[status];
                        return status + '<br/>' +
                               '呆滞金额: ¥' + (parseFloat(config.formatter(data.amount))).toFixed(2) + '万元<br/>' +
                               '记录数: ' + data.count + '条<br/>' +
                               '占比: ' + params.percent + '%';
                    }
                },
                series: [{
                    type: 'pie',
                    radius: ['50%', '70%'],
                    data: sortedData.map(([name, value]) => ({
                        name: name,
                        value: value.amount
                    })),
                    itemStyle: {
                        borderRadius: 5,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%'
                    }
                }]
            };

            charts.cwReasonableChart.setOption(option);
        }

        // 判断是否为专用件
        function isExclusive(item) {
            const status = item.是否为理想专用 || item.是否认可为行业内理想专用 || '';
            return status.includes('是') || status.includes('认可') || status.toLowerCase().includes('yes');
        }

        // 更新按零件类型的专用件占比图表
        function updateExclusiveByTypeChart(data) {
            console.log('[DEBUG v2.3.10] updateExclusiveByTypeChart 收到数据:', data.length, '条');
            const config = getMetricConfig();
            const typeData = {};

            data.forEach(item => {
                const type = item.零件类型 || '未分类';
                if (!typeData[type]) {
                    typeData[type] = {
                        exclusive: { count: 0, amount: 0 },
                        nonExclusive: { count: 0, amount: 0 }
                    };
                }

                const amount = getMetricValue(item, 'total') || 0;
                if (isExclusive(item)) {
                    typeData[type].exclusive.count += 1;
                    typeData[type].exclusive.amount += amount;
                } else {
                    typeData[type].nonExclusive.count += 1;
                    typeData[type].nonExclusive.amount += amount;
                }
            });

            console.log('[DEBUG v2.3.10] typeData统计结果:', Object.keys(typeData).length, '种类型', typeData);

            const chartDom = safeGetElement('exclusivityPieChart'); // v2.3.7.4
            if (!chartDom) {
                console.warn('[Exclusive] Chart container not found: exclusivityPieChart');
                return;
            }
            if (!charts.exclusiveByTypeChart) {
                charts.exclusiveByTypeChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        name: '专用件',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '50%'],
                        data: Object.entries(typeData).map(([name, value]) => ({
                            name: name,
                            value: value.exclusive.count
                        })),
                        itemStyle: {
                            borderRadius: 5,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true
                        }
                    }
                ]
            };

            charts.exclusiveByTypeChart.setOption(option);
        }

        // 更新按PSM专业组的专用件占比图表
        function updateExclusiveByGroupChart(data) {
            console.log('[DEBUG v2.3.10] updateExclusiveByGroupChart 收到数据:', data.length, '条');
            const config = getMetricConfig();
            const groupData = {};

            data.forEach(item => {
                const group = item.PSM专业组 || '未分类';
                if (!groupData[group]) {
                    groupData[group] = {
                        exclusive: { count: 0, amount: 0 },
                        nonExclusive: { count: 0, amount: 0 }
                    };
                }

                const amount = getMetricValue(item, 'total') || 0;
                if (isExclusive(item)) {
                    groupData[group].exclusive.count += 1;
                    groupData[group].exclusive.amount += amount;
                } else {
                    groupData[group].nonExclusive.count += 1;
                    groupData[group].nonExclusive.amount += amount;
                }
            });

            console.log('[DEBUG v2.3.10] groupData统计结果:', Object.keys(groupData).length, '个专业组', groupData);

            const sortedGroups = Object.entries(groupData)
                .sort((a, b) => (b[1].exclusive.amount + b[1].nonExclusive.amount) - (a[1].exclusive.amount + a[1].nonExclusive.amount))
                .map(item => item[0]);

            const exclusiveCounts = sortedGroups.map(group => groupData[group].exclusive.count);
            const nonExclusiveCounts = sortedGroups.map(group => groupData[group].nonExclusive.count);
            const exclusivePercentages = sortedGroups.map(group => {
                const total = groupData[group].exclusive.count + groupData[group].nonExclusive.count;
                return total > 0 ? ((groupData[group].exclusive.count / total) * 100).toFixed(1) : 0;
            });

            const chartDom = safeGetElement('exclusivityMultiChart'); // v2.3.7.4
            if (!chartDom) {
                console.warn('[Exclusive] Chart container not found: exclusivityMultiChart');
                return;
            }
            if (!charts.exclusiveByGroupChart) {
                charts.exclusiveByGroupChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const group = params[0].axisValue;
                        const data = groupData[group];
                        const total = data.exclusive.count + data.nonExclusive.count;
                        const percentage = total > 0 ? ((data.exclusive.count / total) * 100).toFixed(1) : 0;
                        return group + '<br/>' +
                               '专用件: ' + data.exclusive.count + '条 (¥' + (parseFloat(config.formatter(data.exclusive.amount))).toFixed(2) + '万)<br/>' +
                               '非专用件: ' + data.nonExclusive.count + '条 (¥' + (data.parseFloat(config.formatter(nonExclusive.amount))).toFixed(2) + '万)<br/>' +
                               '专用件占比: ' + percentage + '%';
                    }
                },
                legend: {
                    data: ['专用件', '非专用件', '专用件占比'],
                    top: 10
                },
                grid: { left: '3%', right: '10%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: sortedGroups
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '数量(条)',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '占比(%)',
                        position: 'right',
                        max: 100
                    }
                ],
                series: [
                    {
                        name: '专用件',
                        type: 'bar',
                        stack: 'total',
                        data: exclusiveCounts,
                        itemStyle: { color: '#667eea' },
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: '非专用件',
                        type: 'bar',
                        stack: 'total',
                        data: nonExclusiveCounts,
                        itemStyle: { color: '#e0e0e0' },
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: '专用件占比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: exclusivePercentages,
                        itemStyle: { color: '#f5576c' },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%'
                        }
                    }
                ]
            };

            charts.exclusiveByGroupChart.setOption(option);
        }

        // 更新专用件对比分析
        function updateExclusiveComparisonChart(data) {
            console.log('[DEBUG v2.3.10] updateExclusiveComparisonChart 收到数据:', data.length, '条');
            const exclusiveData = data.filter(item => (item.是否认可为行业内理想专用 || '').includes('是'));
            const nonExclusiveData = data.filter(item => !(item.是否认可为行业内理想专用 || '').includes('是'));

            console.log('[DEBUG v2.3.10] 专用件:', exclusiveData.length, '条, 非专用件:', nonExclusiveData.length, '条');

            const config = getMetricConfig();
            const exclusiveAmount = exclusiveData.reduce((sum, item) => sum + (getMetricValue(item, 'total') || 0), 0);
            const nonExclusiveAmount = nonExclusiveData.reduce((sum, item) => sum + (getMetricValue(item, 'total') || 0), 0);

            const chartDom = safeGetElement('exclusiveComparisonChart'); // v2.3.9
            if (!chartDom) {
                console.warn('[Exclusive] Chart container not found: exclusiveComparisonChart');
                return;
            }
            if (!charts.exclusiveComparisonChart) {
                charts.exclusiveComparisonChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}万元 ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: [
                        { value: (exclusiveAmount / 10000).toFixed(2), name: '专用件' },
                        { value: (nonExclusiveAmount / 10000).toFixed(2), name: '非专用件' }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };

            charts.exclusiveComparisonChart.setOption(option);
        }

        // 更新数据表格
        function updateDataTable(data) {
            const tbody = safeGetElement('tableBody');
            if (!tbody) return; // v2.3.7: 如果表格不存在则跳过

            tbody.innerHTML = '';

            data.slice(0, 100).forEach(item => { // 只显示前100条
                const row = tbody.insertRow();
                row.insertCell(0).textContent = (parseFloat(item.呆滞金额) || 0).toFixed(2);
                row.insertCell(1).textContent = item.分类 || '-';
                row.insertCell(2).textContent = item.PSM专业组 || '-';
                row.insertCell(3).textContent = item.T1供应商名称 || '-';
                row.insertCell(4).textContent = item.Tn零部件品类 || '-';
                row.insertCell(5).textContent = item.零件类型 || '-';

                const eopCell = row.insertCell(6);
                const eop = item.是否EOP;
                if (eop === '是') {
                    eopCell.innerHTML = '<span class="badge bg-success badge-custom">是</span>';
                } else if (eop === '否') {
                    eopCell.innerHTML = '<span class="badge bg-danger badge-custom">否</span>';
                } else {
                    eopCell.innerHTML = '<span class="badge bg-secondary badge-custom">-</span>';
                }

                row.insertCell(7).textContent = (getMetricValue(item, 'total') || 0).toLocaleString();
            });

            if (data.length > 100) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 8;
                cell.className = 'text-center text-muted';
                cell.textContent = `显示前100条，共${data.length}条记录`;
            }
        }

        // 表格筛选
        function filterTable() {
            const input = safeGetElement('searchInput');
            const table = safeGetElement('dataTable');
            if (!input || !table) return; // v2.3.7: 防御性检查

            const filter = input.value.toUpperCase();
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                let txtValue = tr[i].textContent || tr[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }

        // 导出PDF
        async function exportToPDF() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            button.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // 添加标题
                pdf.setFontSize(20);
                pdf.setTextColor(102, 126, 234);
                pdf.text('EOP呆滞管控数据看板', pageWidth / 2, 20, { align: 'center' });

                pdf.setFontSize(10);
                pdf.setTextColor(100);
                const dateStr = new Date().toLocaleDateString('zh-CN');
                pdf.text(`生成日期: ${dateStr}`, pageWidth / 2, 28, { align: 'center' });

                // 获取当前显示的数据
                let data = [];
                if (currentSheet === 'ALL') {
                    data = [...allData.L987, ...allData.L6];
                } else {
                    data = allData[currentSheet] || [];
                }

                const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
                if (selectedTiers.length > 0) {
                    data = data.filter(item => selectedTiers.includes(item.分类));
                }

                // 添加统计数据
                const totalRecords = data.length;
                const totalAmount = data.reduce((sum, item) => sum + (getMetricValue(item, 'total') || 0), 0);
                const t1Amount = data.reduce((sum, item) => sum + (getMetricValue(item, 't1') || 0), 0);
                const idealAmount = data.reduce((sum, item) => sum + (getMetricValue(item, 'ideal') || 0), 0);

                let yPos = 40;
                pdf.setFontSize(12);
                pdf.setTextColor(0);
                pdf.text('关键指标摘要', 15, yPos);
                yPos += 8;

                pdf.setFontSize(10);
                pdf.text(`总记录数: ${totalRecords.toLocaleString()} 条`, 20, yPos);
                yPos += 6;
                pdf.text(`呆滞总金额: ¥${(totalAmount / 10000).toFixed(2)} 万元`, 20, yPos);
                yPos += 6;
                pdf.text(`T1端金额: ¥${(t1Amount / 10000).toFixed(2)} 万元`, 20, yPos);
                yPos += 6;
                pdf.text(`理想端金额: ¥${(idealAmount / 10000).toFixed(2)} 万元`, 20, yPos);
                yPos += 10;

                // 捕获图表区域
                const chartElements = [
                    { id: 'tierChart', title: '呆滞金额阶梯分布' },
                    { id: 'groupChart', title: 'PSM专业组分析' },
                    { id: 'supplierChart', title: '供应商呆滞金额排名' },
                    { id: 'categoryChart', title: '零部件品类分析' }
                ];

                for (const chartInfo of chartElements) {
                    const chartElement = document.getElementById(chartInfo.id);
                    if (chartElement && yPos < pageHeight - 80) {
                        // 使用html2canvas捕获图表
                        const canvas = await html2canvas(chartElement, {
                            scale: 2,
                            backgroundColor: '#ffffff',
                            logging: false
                        });

                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = pageWidth - 30;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;

                        // 检查是否需要新页面
                        if (yPos + imgHeight + 10 > pageHeight - 10) {
                            pdf.addPage();
                            yPos = 20;
                        }

                        pdf.setFontSize(11);
                        pdf.setTextColor(102, 126, 234);
                        pdf.text(chartInfo.title, 15, yPos);
                        yPos += 5;

                        pdf.addImage(imgData, 'PNG', 15, yPos, imgWidth, Math.min(imgHeight, 80));
                        yPos += Math.min(imgHeight, 80) + 10;
                    }
                }

                // 添加页脚
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150);
                    pdf.text(`第 ${i} 页 / 共 ${totalPages} 页`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                // 保存PDF
                pdf.save(`EOP呆滞管控数据看板_${dateStr.replace(/\//g, '-')}.pdf`);

                button.innerHTML = originalText;
                button.disabled = false;

                // 显示成功消息
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;';
                successDiv.innerHTML = '<i class="fas fa-check-circle"></i> PDF导出成功!';
                document.body.appendChild(successDiv);
                setTimeout(() => successDiv.remove(), 3000);

            } catch (error) {
                console.error('PDF导出失败:', error);
                button.innerHTML = originalText;
                button.disabled = false;

                // 显示错误消息
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999;';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> PDF导出失败: ' + error.message;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        // 重置筛选
        function resetFilters() {
            document.getElementById('sheetSelector').value = 'L987';
            document.getElementById('topN').value = '10';
            document.getElementById('metricSelector').value = 'amount';

            // 取消所有阶梯复选框
            document.querySelectorAll('.tier-checkbox').forEach(cb => {
                cb.checked = false;
            });

            // 选中所有类型复选框
            document.querySelectorAll('.type-checkbox').forEach(cb => {
                cb.checked = true;
            });

            currentSheet = 'L987';
            updateDashboard();
        }

        // ========== 专用零件交互查询功能 ==========

        // 响应式图表调整
        function setupChartResize() {
            // 窗口大小改变时调整图表
            window.addEventListener('resize', function() {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            });

            // Tab切换时调整图表大小
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(button => {
                button.addEventListener('shown.bs.tab', function () {
                    setTimeout(() => {
                        Object.values(charts).forEach(chart => {
                            if (chart) chart.resize();
                        });
                    }, 100);
                });
            });
        }

        // 更新PSM专业组选项
        function updateExclusiveQueryPSMOptions(data) {
            const psmSelect = document.getElementById('exclusiveQueryPSM');
            const psmSet = new Set();

            data.forEach(item => {
                if (item.PSM专业组) psmSet.add(item.PSM专业组);
            });

            psmSelect.innerHTML = '<option value="">--请选择--</option>';
            Array.from(psmSet).sort().forEach(psm => {
                const option = document.createElement('option');
                option.value = psm;
                option.textContent = psm;
                psmSelect.appendChild(option);
            });
        }

        // 当选择PSM专业组后，更新零件选项
        function updateExclusiveQueryParts() {
            let data = [];
            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = document.getElementById('exclusiveQueryPSM').value;
            if (!selectedPSM) {
                document.getElementById('exclusiveQueryStats').innerHTML = '请选择PSM专业组';
                document.getElementById('exclusiveQueryPart').innerHTML = '<option value="">--全部零件--</option>';
                if (charts.exclusiveQueryChart) charts.exclusiveQueryChart.clear();
                document.getElementById('exclusivePartsTable').querySelector('tbody').innerHTML = '';
                return;
            }

            // 筛选该PSM专业组的数据
            const psmData = data.filter(item => item.PSM专业组 === selectedPSM);

            // 收集该PSM下的所有零部件名称（去重）
            const partNames = new Set();
            psmData.forEach(item => {
                if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                    partNames.add(item.T1零部件名称);
                }
            });

            const partSelect = safeGetElement('exclusiveQueryPart');
            partSelect.innerHTML = '<option value="">--全部零件--</option>';
            Array.from(partNames).sort().forEach(partName => {
                const option = document.createElement('option');
                option.value = partName;
                option.textContent = partName;
                partSelect.appendChild(option);
            });

            // 显示该PSM专业组的统计
            updateExclusivePartDetail();
        }

        // 更新专用件详情
        function updateExclusivePartDetail() {
            let data = [];
            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = document.getElementById('exclusiveQueryPSM').value;
            const selectedPartName = safeGetElement('exclusiveQueryPart').value;

            if (!selectedPSM) return;

            // 筛选数据：先按PSM专业组，再按零部件名称
            let filteredData = data.filter(item => item.PSM专业组 === selectedPSM);
            if (selectedPartName) {
                filteredData = filteredData.filter(item => item.T1零部件名称 === selectedPartName);
            }

            // 统计专用件和非专用件
            let exclusiveCount = 0, nonExclusiveCount = 0;
            let exclusiveAmount = 0, nonExclusiveAmount = 0;
            const allParts = [];

            filteredData.forEach(item => {
                const isExcl = isExclusive(item);
                allParts.push({ ...item, isExclusive: isExcl });

                if (isExcl) {
                    exclusiveCount++;
                    exclusiveAmount += getMetricValue(item, 'total');
                } else {
                    nonExclusiveCount++;
                    nonExclusiveAmount += getMetricValue(item, 'total');
                }
            });

            const totalCount = exclusiveCount + nonExclusiveCount;
            const percentage = totalCount > 0 ? ((exclusiveCount / totalCount) * 100).toFixed(1) : 0;
            const config = getMetricConfig();

            // 更新统计信息
            const displayName = selectedPartName ? `${selectedPSM} - ${selectedPartName}` : selectedPSM;
            document.getElementById('exclusiveQueryStats').innerHTML = `
                <strong>${displayName}</strong><br/>
                总计：${totalCount}条 | 专用件：${exclusiveCount}条 (${percentage}%) | 非专用件：${nonExclusiveCount}条<br/>
                专用件${config.label}：${config.displayFormatter(exclusiveAmount)}
            `;

            // 更新图表（如果容器存在）
            const chartDom = safeGetElement('exclusiveQueryChart');
            if (chartDom) {
                if (!charts.exclusiveQueryChart) {
                    charts.exclusiveQueryChart = echarts.init(chartDom);
                }

                const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}条 ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: [
                        { value: exclusiveCount, name: '专用件', itemStyle: { color: '#5470c6' } },
                        { value: nonExclusiveCount, name: '非专用件', itemStyle: { color: '#91cc75' } }
                    ],
                    label: {
                        formatter: '{b}\n{c}条 ({d}%)'
                    }
                }]
            };

                charts.exclusiveQueryChart.setOption(option);
            }

            // 更新零件列表
            const tbody = document.getElementById('exclusivePartsTable').querySelector('tbody');
            tbody.innerHTML = '';
            allParts.sort((a, b) => getMetricValue(b, 'total') - getMetricValue(a, 'total'));
            allParts.slice(0, 100).forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.T1零部件名称 || '-';
                row.insertCell(1).textContent = item.T1物料编码 || '-';
                row.insertCell(2).textContent = item.T1供应商名称 || '-';
                row.insertCell(3).textContent = config.displayFormatter(getMetricValue(item, 'total'));
                const exclusiveCell = row.insertCell(4);
                if (item.isExclusive) {
                    exclusiveCell.innerHTML = '<span class="badge bg-success">是</span>';
                } else {
                    exclusiveCell.innerHTML = '<span class="badge bg-secondary">否</span>';
                }
            });

            if (allParts.length > 100) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.className = 'text-center text-muted';
                cell.textContent = `显示前100条，共${allParts.length}条记录`;
            }
        }

        // ========== LT和CW交互查询功能 ==========

        // 更新LTCW查询的PSM专业组选项
        function updateLTCWQueryPSMOptions(data) {
            const psmSelect = document.getElementById('ltcwQueryPSM');
            const psmSet = new Set();

            data.forEach(item => {
                if (item.PSM专业组) psmSet.add(item.PSM专业组);
            });

            psmSelect.innerHTML = '<option value="">--请选择--</option>';
            Array.from(psmSet).sort().forEach(psm => {
                const option = document.createElement('option');
                option.value = psm;
                option.textContent = psm;
                psmSelect.appendChild(option);
            });
        }

        // 当选择PSM专业组后，更新零件选项
        function updateLTCWQueryParts() {
            let data = [];
            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = document.getElementById('ltcwQueryPSM').value;
            if (!selectedPSM) {
                document.getElementById('ltcwQueryStats').innerHTML = '请选择PSM专业组';
                document.getElementById('ltcwQueryPart').innerHTML = '<option value="">--全部零件--</option>';
                if (charts.ltcwQueryChartLT) charts.ltcwQueryChartLT.clear();
                if (charts.ltcwQueryChartCW) charts.ltcwQueryChartCW.clear();
                document.getElementById('ltcwPartsTable').querySelector('tbody').innerHTML = '';
                return;
            }

            // 筛选该PSM专业组的数据
            const psmData = data.filter(item => item.PSM专业组 === selectedPSM);

            // 收集该PSM下的所有零部件名称（去重）
            const partNames = new Set();
            psmData.forEach(item => {
                if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                    partNames.add(item.T1零部件名称);
                }
            });

            const partSelect = document.getElementById('ltcwQueryPart');
            partSelect.innerHTML = '<option value="">--全部零件--</option>';
            Array.from(partNames).sort().forEach(partName => {
                const option = document.createElement('option');
                option.value = partName;
                option.textContent = partName;
                partSelect.appendChild(option);
            });

            // 显示该PSM专业组的统计
            updateLTCWPartDetail();
        }

        // 更新LT&CW零件详情
        function updateLTCWPartDetail() {
            let data = [];
            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = document.getElementById('ltcwQueryPSM').value;
            const selectedPartName = document.getElementById('ltcwQueryPart').value;

            if (!selectedPSM) return;

            // 筛选数据：先按PSM专业组，再按零部件名称
            let filteredData = data.filter(item => item.PSM专业组 === selectedPSM);
            if (selectedPartName) {
                filteredData = filteredData.filter(item => item.T1零部件名称 === selectedPartName);
            }

            // 收集LT和CW数据
            const ltValues = [];
            const cwValues = [];
            filteredData.forEach(item => {
                if (item.LT > 0) ltValues.push(item.LT);
                if (item.CW > 0) cwValues.push(item.CW);
            });

            // 计算统计值
            const calculateStats = (values) => {
                if (values.length === 0) return { avg: 0, max: 0, min: 0, median: 0 };
                values.sort((a, b) => a - b);
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const max = values[values.length - 1];
                const min = values[0];
                const median = values.length % 2 === 0
                    ? (values[values.length / 2 - 1] + values[values.length / 2]) / 2
                    : values[Math.floor(values.length / 2)];
                return { avg, max, min, median };
            };

            const ltStats = calculateStats(ltValues);
            const cwStats = calculateStats(cwValues);
            const config = getMetricConfig();

            // 更新统计信息
            const displayName = selectedPartName ? `${selectedPSM} - ${selectedPartName}` : selectedPSM;
            document.getElementById('ltcwQueryStats').innerHTML = `
                <strong>${displayName}</strong><br/>
                样本数：${filteredData.length}条<br/>
                LT - 平均:${ltStats.avg.toFixed(2)} 最大:${ltStats.max.toFixed(2)} 最小:${ltStats.min.toFixed(2)}<br/>
                CW - 平均:${cwStats.avg.toFixed(2)} 最大:${cwStats.max.toFixed(2)} 最小:${cwStats.min.toFixed(2)}
            `;

            // 更新LT图表
            const ltChartDom = safeGetElement('ltcwQueryChartLT'); // v2.3.8
            if (!ltChartDom) return;
            if (!charts.ltcwQueryChartLT) {
                charts.ltcwQueryChartLT = echarts.init(ltChartDom);
            }

            const ltOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: 'LT: {c}'
                },
                xAxis: {
                    type: 'category',
                    data: filteredData.map((_, i) => i + 1)
                },
                yAxis: {
                    type: 'value',
                    name: 'LT'
                },
                series: [{
                    data: filteredData.map(item => item.LT),
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#83bff6' },
                            { offset: 1, color: '#188df0' }
                        ])
                    },
                    markLine: {
                        data: [
                            {
                                name: '平均值',
                                yAxis: ltStats.avg,
                                lineStyle: {
                                    color: '#5470c6',
                                    type: 'solid',
                                    width: 2
                                },
                                label: {
                                    formatter: '平均: ' + ltStats.avg.toFixed(2) + '月',
                                    position: 'end'
                                }
                            },
                            {
                                name: '中位值',
                                yAxis: ltStats.median,
                                lineStyle: {
                                    color: '#ee6666',
                                    type: 'dashed',
                                    width: 2
                                },
                                label: {
                                    formatter: '中位: ' + ltStats.median.toFixed(2) + '月',
                                    position: 'end'
                                }
                            }
                        ]
                    }
                }]
            };

            charts.ltcwQueryChartLT.setOption(ltOption);

            // 更新CW图表
            const cwChartDom = safeGetElement('ltcwQueryChartCW'); // v2.3.8
            if (!cwChartDom) return;
            if (!charts.ltcwQueryChartCW) {
                charts.ltcwQueryChartCW = echarts.init(cwChartDom);
            }

            const cwOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: 'CW: {c}'
                },
                xAxis: {
                    type: 'category',
                    data: filteredData.map((_, i) => i + 1)
                },
                yAxis: {
                    type: 'value',
                    name: 'CW'
                },
                series: [{
                    data: filteredData.map(item => item.CW),
                    type: 'bar',
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#fccb05' },
                            { offset: 1, color: '#f77062' }
                        ])
                    },
                    markLine: {
                        data: [
                            {
                                name: '平均值',
                                yAxis: cwStats.avg,
                                lineStyle: {
                                    color: '#5470c6',
                                    type: 'solid',
                                    width: 2
                                },
                                label: {
                                    formatter: '平均: ' + cwStats.avg.toFixed(2) + '月',
                                    position: 'end'
                                }
                            },
                            {
                                name: '中位值',
                                yAxis: cwStats.median,
                                lineStyle: {
                                    color: '#ee6666',
                                    type: 'dashed',
                                    width: 2
                                },
                                label: {
                                    formatter: '中位: ' + cwStats.median.toFixed(2) + '月',
                                    position: 'end'
                                }
                            }
                        ]
                    }
                }]
            };

            charts.ltcwQueryChartCW.setOption(cwOption);

            // 更新零件列表
            const tbody = document.getElementById('ltcwPartsTable').querySelector('tbody');
            tbody.innerHTML = '';
            filteredData.sort((a, b) => getMetricValue(b, 'total') - getMetricValue(a, 'total'));
            filteredData.slice(0, 100).forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.T1零部件名称 || '-';
                row.insertCell(1).textContent = item.T1物料编码 || '-';
                row.insertCell(2).textContent = item.T1供应商名称 || '-';
                row.insertCell(3).textContent = item.LT ? item.LT.toFixed(2) : '-';
                row.insertCell(4).textContent = item.CW ? item.CW.toFixed(2) : '-';
                row.insertCell(5).textContent = config.displayFormatter(getMetricValue(item, 'total'));
            });

            if (filteredData.length > 100) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6;
                cell.className = 'text-center text-muted';
                cell.textContent = `显示前100条，共${filteredData.length}条记录`;
            }
        }

        // ========== LT和CW统计分析功能 ==========

        function updateLTCWStats(data) {
            // 如果没有传入data，则从当前视图获取
            if (!data) {
                data = [];
                if (currentSheet === 'ALL') {
                    data = [...allData.L987, ...allData.L6];
                } else {
                    data = allData[currentSheet] || [];
                }

                // 应用阶梯筛选
                const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
                if (selectedTiers.length > 0) {
                    data = data.filter(item => selectedTiers.includes(item.分类));
                }

                // 应用类型筛选
                const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
                if (selectedTypes.length > 0) {
                    data = data.filter(item => {
                        const partType = item.零件类型 || '';
                        if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                        if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                        return false;
                    });
                }
            }

            // 获取统计维度
            const dimension = document.getElementById('ltcwStatsDimension').value;

            // 按选择的维度分组统计
            const groupStats = {};

            data.forEach(item => {
                let groupKey;
                switch(dimension) {
                    case 'category':
                        groupKey = item.Tn零部件品类 || '未分类';
                        break;
                    case 'PSM': // v2.3.11: 修复大小写匹配
                        groupKey = item.PSM专业组 || '未分类';
                        break;
                    case 'categoryAndPSM': // v2.3.11: 修复大小写匹配
                        const cat = item.Tn零部件品类 || '未分类';
                        const psm = item.PSM专业组 || '未分类';
                        groupKey = `${cat} - ${psm}`;
                        break;
                    default:
                        groupKey = '未分类';
                }

                if (!groupStats[groupKey]) {
                    groupStats[groupKey] = { ltValues: [], cwValues: [] };
                }
                if (item.LT > 0) groupStats[groupKey].ltValues.push(item.LT);
                if (item.CW > 0) groupStats[groupKey].cwValues.push(item.CW);
            });

            // 计算统计值
            const calculateStats = (values) => {
                if (values.length === 0) return { avg: 0, max: 0, min: 0, median: 0 };

                values.sort((a, b) => a - b);
                const sum = values.reduce((a, b) => a + b, 0);
                const avg = sum / values.length;
                const max = values[values.length - 1];
                const min = values[0];
                const median = values.length % 2 === 0
                    ? (values[values.length / 2 - 1] + values[values.length / 2]) / 2
                    : values[Math.floor(values.length / 2)];

                return { avg, max, min, median };
            };

            // 更新表格（如果存在）
            const tableElement = document.getElementById('ltCwStatsTable');
            if (tableElement) {
                const tbody = tableElement.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = '';

                    // 按分类名称排序
                    const sortedGroups = Object.entries(groupStats).sort((a, b) => a[0].localeCompare(b[0]));

                    sortedGroups.forEach(([groupName, data]) => {
                        const ltStats = calculateStats(data.ltValues);
                        const cwStats = calculateStats(data.cwValues);
                        const count = Math.max(data.ltValues.length, data.cwValues.length);

                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = groupName;
                        row.insertCell(1).textContent = count;
                        row.insertCell(2).textContent = ltStats.avg.toFixed(2);
                        row.insertCell(3).textContent = ltStats.max.toFixed(2);
                        row.insertCell(4).textContent = ltStats.min.toFixed(2);
                        row.insertCell(5).textContent = ltStats.median.toFixed(2);
                        row.insertCell(6).textContent = cwStats.avg.toFixed(2);
                        row.insertCell(7).textContent = cwStats.max.toFixed(2);
                        row.insertCell(8).textContent = cwStats.min.toFixed(2);
                        row.insertCell(9).textContent = cwStats.median.toFixed(2);
                    });
                }
            }

            // 更新LT图表
            updateLTChart(groupStats);

            // 更新CW图表
            updateCWChart(groupStats);
        }

        function updateLTChart(groupStats) {
            const chartDom = safeGetElement('ltStatsChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.ltStatsChart) {
                charts.ltStatsChart = echarts.init(chartDom);
            }

            const groups = Object.keys(groupStats).sort();
            const avgData = groups.map(g => {
                const values = groupStats[g].ltValues;
                return values.length > 0 ? (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2) : 0;
            });
            const maxData = groups.map(g => {
                const values = groupStats[g].ltValues;
                return values.length > 0 ? Math.max(...values).toFixed(2) : 0;
            });
            const minData = groups.map(g => {
                const values = groupStats[g].ltValues;
                return values.length > 0 ? Math.min(...values).toFixed(2) : 0;
            });
            const medianData = groups.map(g => {
                const values = groupStats[g].ltValues;
                if (values.length === 0) return 0;
                values.sort((a, b) => a - b);
                const median = values.length % 2 === 0
                    ? (values[values.length / 2 - 1] + values[values.length / 2]) / 2
                    : values[Math.floor(values.length / 2)];
                return median.toFixed(2);
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: ['平均值', '最大值', '最小值', '中位数'],
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: groups,
                    axisLabel: {
                        rotate: 45,
                        interval: 0,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'LT'
                },
                series: [
                    {
                        name: '平均值',
                        type: 'bar',
                        data: avgData,
                        itemStyle: { color: '#5470c6' }
                    },
                    {
                        name: '最大值',
                        type: 'line',
                        data: maxData,
                        itemStyle: { color: '#ee6666' }
                    },
                    {
                        name: '最小值',
                        type: 'line',
                        data: minData,
                        itemStyle: { color: '#91cc75' }
                    },
                    {
                        name: '中位数',
                        type: 'line',
                        data: medianData,
                        itemStyle: { color: '#fac858' },
                        lineStyle: { type: 'dashed' }
                    }
                ]
            };

            charts.ltStatsChart.setOption(option);
        }

        function updateCWChart(groupStats) {
            const chartDom = safeGetElement('cwStatsChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.cwStatsChart) {
                charts.cwStatsChart = echarts.init(chartDom);
            }

            const groups = Object.keys(groupStats).sort();
            const avgData = groups.map(g => {
                const values = groupStats[g].cwValues;
                return values.length > 0 ? (values.reduce((a,b) => a+b, 0) / values.length).toFixed(2) : 0;
            });
            const maxData = groups.map(g => {
                const values = groupStats[g].cwValues;
                return values.length > 0 ? Math.max(...values).toFixed(2) : 0;
            });
            const minData = groups.map(g => {
                const values = groupStats[g].cwValues;
                return values.length > 0 ? Math.min(...values).toFixed(2) : 0;
            });
            const medianData = groups.map(g => {
                const values = groupStats[g].cwValues;
                if (values.length === 0) return 0;
                values.sort((a, b) => a - b);
                const median = values.length % 2 === 0
                    ? (values[values.length / 2 - 1] + values[values.length / 2]) / 2
                    : values[Math.floor(values.length / 2)];
                return median.toFixed(2);
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: ['平均值', '最大值', '最小值', '中位数'],
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: groups,
                    axisLabel: {
                        rotate: 45,
                        interval: 0,
                        fontSize: 10
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'CW'
                },
                series: [
                    {
                        name: '平均值',
                        type: 'bar',
                        data: avgData,
                        itemStyle: { color: '#fac858' }
                    },
                    {
                        name: '最大值',
                        type: 'line',
                        data: maxData,
                        itemStyle: { color: '#ee6666' }
                    },
                    {
                        name: '最小值',
                        type: 'line',
                        data: minData,
                        itemStyle: { color: '#91cc75' }
                    },
                    {
                        name: '中位数',
                        type: 'line',
                        data: medianData,
                        itemStyle: { color: '#73c0de' },
                        lineStyle: { type: 'dashed' }
                    }
                ]
            };

            charts.cwStatsChart.setOption(option);
        }

        // ==================== 新增功能函数 ====================

        // 1. 帕累托分析 - 零件
        function updateParetoAnalysis(data) {
            // 按零件分组统计金额
            const partStats = {};
            data.forEach(item => {
                const partName = item.T1零部件名称 || '未知';
                const amount = parseFloat(item.呆滞总金额) || 0;
                partStats[partName] = (partStats[partName] || 0) + amount;
            });

            // 排序
            const sorted = Object.entries(partStats).sort((a, b) => b[1] - a[1]);
            const totalAmount = sorted.reduce((sum, item) => sum + item[1], 0);

            // 计算累计百分比
            let cumulative = 0;
            const paretoData = sorted.map(([name, amount]) => {
                cumulative += amount;
                return {
                    name,
                    amount,
                    cumulative: (cumulative / totalAmount * 100).toFixed(2)
                };
            });

            // 计算80/20信息
            const top20Percent = Math.ceil(paretoData.length * 0.2);
            const top20Amount = paretoData.slice(0, top20Percent).reduce((sum, item) => sum + item.amount, 0);
            const top20Ratio = ((top20Amount / totalAmount) * 100).toFixed(1);

            document.getElementById('paretoPartInfo').textContent =
                `前20%零件(${top20Percent}个)占总金额的${top20Ratio}%`;

            // 绘制图表
            const chartDom = safeGetElement('paretoPartChart'); // v2.3.7.3
            if (!chartDom) {
                console.warn('[Pareto] Chart container not found: paretoPartChart');
                return;
            }
            if (!charts.paretoPartChart) {
                charts.paretoPartChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['金额', '累计占比']
                },
                xAxis: {
                    type: 'category',
                    data: paretoData.slice(0, 30).map(item => item.name),
                    axisLabel: { rotate: 45, interval: 0, fontSize: 10 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '金额(万元)',
                        axisLabel: { formatter: value => (value / 10000).toFixed(0) }
                    },
                    {
                        type: 'value',
                        name: '累计占比(%)',
                        min: 0,
                        max: 100
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: paretoData.slice(0, 30).map(item => item.amount),
                        itemStyle: { color: '#5470c6' }
                    },
                    {
                        name: '累计占比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: paretoData.slice(0, 30).map(item => parseFloat(item.cumulative)),
                        itemStyle: { color: '#ee6666' },
                        lineStyle: { width: 2 },
                        markLine: {
                            data: [{ yAxis: 80, name: '80%线', lineStyle: { type: 'dashed', color: '#ff0000' } }]
                        }
                    }
                ]
            };

            charts.paretoPartChart.setOption(option);

            // 供应商帕累托分析
            const supplierStats = {};
            data.forEach(item => {
                const supplier = item.T1供应商名称 || '未知';
                const amount = parseFloat(item.呆滞总金额) || 0;
                supplierStats[supplier] = (supplierStats[supplier] || 0) + amount;
            });

            const sortedSuppliers = Object.entries(supplierStats).sort((a, b) => b[1] - a[1]);
            let cumulativeSupplier = 0;
            const paretoSupplierData = sortedSuppliers.map(([name, amount]) => {
                cumulativeSupplier += amount;
                return {
                    name,
                    amount,
                    cumulative: (cumulativeSupplier / totalAmount * 100).toFixed(2)
                };
            });

            const top20SupplierCount = Math.ceil(paretoSupplierData.length * 0.2);
            const top20SupplierAmount = paretoSupplierData.slice(0, top20SupplierCount).reduce((sum, item) => sum + item.amount, 0);
            const top20SupplierRatio = ((top20SupplierAmount / totalAmount) * 100).toFixed(1);

            document.getElementById('paretoSupplierInfo').textContent =
                `前20%供应商(${top20SupplierCount}家)占总金额的${top20SupplierRatio}%`;

            const chartDom2 = safeGetElement('paretoSupplierChart'); // v2.3.7.3
            if (!chartDom2) {
                console.warn('[Pareto] Chart container not found: paretoSupplierChart');
                return;
            }
            if (!charts.paretoSupplierChart) {
                charts.paretoSupplierChart = echarts.init(chartDom2);
            }

            const option2 = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['金额', '累计占比']
                },
                xAxis: {
                    type: 'category',
                    data: paretoSupplierData.slice(0, 20).map(item => item.name),
                    axisLabel: { rotate: 45, interval: 0, fontSize: 10 }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '金额(万元)',
                        axisLabel: { formatter: value => (value / 10000).toFixed(0) }
                    },
                    {
                        type: 'value',
                        name: '累计占比(%)',
                        min: 0,
                        max: 100
                    }
                ],
                series: [
                    {
                        name: '金额',
                        type: 'bar',
                        data: paretoSupplierData.slice(0, 20).map(item => item.amount),
                        itemStyle: { color: '#91cc75' }
                    },
                    {
                        name: '累计占比',
                        type: 'line',
                        yAxisIndex: 1,
                        data: paretoSupplierData.slice(0, 20).map(item => parseFloat(item.cumulative)),
                        itemStyle: { color: '#fac858' },
                        lineStyle: { width: 2 },
                        markLine: {
                            data: [{ yAxis: 80, name: '80%线', lineStyle: { type: 'dashed', color: '#ff0000' } }]
                        }
                    }
                ]
            };

            charts.paretoSupplierChart.setOption(option2);
        }

        // 2. 供应商集中度分析
        function updateSupplierConcentration(data) {
            const supplierStats = {};
            data.forEach(item => {
                const supplier = item.T1供应商名称 || '未知';
                const amount = parseFloat(item.呆滞总金额) || 0;
                supplierStats[supplier] = (supplierStats[supplier] || 0) + amount;
            });

            const sorted = Object.entries(supplierStats).sort((a, b) => b[1] - a[1]);
            const top10 = sorted.slice(0, 10);
            const othersAmount = sorted.slice(10).reduce((sum, item) => sum + item[1], 0);
            const totalAmount = sorted.reduce((sum, item) => sum + item[1], 0);

            const chartData = top10.map(([name, amount]) => ({
                name,
                value: amount
            }));

            if (othersAmount > 0) {
                chartData.push({ name: '其他供应商', value: othersAmount });
            }

            const chartDom = safeGetElement('supplierConcentrationChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.supplierConcentrationChart) {
                charts.supplierConcentrationChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: params => {
                        const percent = ((params.value / totalAmount) * 100).toFixed(2);
                        return `${params.name}<br/>金额: ¥${(params.value / 10000).toFixed(2)}万<br/>占比: ${percent}%`;
                    }
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    type: 'scroll'
                },
                series: [
                    {
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: true,
                            formatter: '{b}: {d}%'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        data: chartData
                    }
                ]
            };

            charts.supplierConcentrationChart.setOption(option);
        }

        // Removed: 供应商风险散点图 (obsolete)

        // Removed: 供应商绩效评分 (obsolete)

        // 5. 单价合理性详细分析
        function updatePriceReasonabilityAnalysis(data) {
            // 单价合理性统计
            const priceStats = {
                '合理': 0,
                '不合理': 0,
                '待确认': 0
            };

            data.forEach(item => {
                const status = item.单价是否合理 || '';
                if (status.includes('不合理')) {
                    priceStats['不合理']++;
                } else if (status.includes('合理')) {
                    priceStats['合理']++;
                } else {
                    priceStats['待确认']++;
                }
            });

            const chartDom = safeGetElement('priceReasonableChart'); // v2.3.8
            if (!chartDom) return;
            if (!charts.priceReasonableChart) {
                charts.priceReasonableChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}件 ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        type: 'pie',
                        radius: '60%',
                        data: [
                            { value: priceStats['合理'], name: '合理', itemStyle: { color: '#67c23a' } },
                            { value: priceStats['不合理'], name: '不合理', itemStyle: { color: '#f56c6c' } },
                            { value: priceStats['待确认'], name: '待确认', itemStyle: { color: '#e6a23c' } }
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };

            charts.priceReasonableChart.setOption(option);

            // 单价不合理按PSM专业组分布
            const unreasonableByPSM = {};
            data.filter(item => (item.单价是否合理 || '').includes('不合理')).forEach(item => {
                const psm = item.PSM专业组 || '未知';
                const amount = parseFloat(item.呆滞总金额) || 0;
                unreasonableByPSM[psm] = (unreasonableByPSM[psm] || 0) + amount;
            });

            const chartDom2 = safeGetElement('priceUnreasonableByPSMChart');
            if (!charts.priceUnreasonableByPSMChart) {
                charts.priceUnreasonableByPSMChart = echarts.init(chartDom2);
            }

            const option2 = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: params => `${params[0].name}<br/>金额: ¥${(params[0].value / 10000).toFixed(2)}万`
                },
                xAxis: {
                    type: 'category',
                    data: Object.keys(unreasonableByPSM),
                    axisLabel: { rotate: 30, interval: 0 }
                },
                yAxis: {
                    type: 'value',
                    name: '金额(万元)',
                    axisLabel: { formatter: value => (value / 10000).toFixed(0) }
                },
                series: [
                    {
                        type: 'bar',
                        data: Object.values(unreasonableByPSM),
                        itemStyle: { color: '#f56c6c' }
                    }
                ]
            };

            charts.priceUnreasonableByPSMChart.setOption(option2);
        }

        // 6. CW_LT合理性详细分析
        function updateCWLTReasonabilityAnalysis(data) {
            // CW_LT合理性统计
            const cwltStats = {
                '合理': 0,
                '不合理': 0,
                '待确认': 0
            };

            data.forEach(item => {
                const status = item.CW_LT是否合理 || '';
                if (status.includes('不合理')) {
                    cwltStats['不合理']++;
                } else if (status.includes('合理')) {
                    cwltStats['合理']++;
                } else {
                    cwltStats['待确认']++;
                }
            });

            const chartDom = safeGetElement('cwltReasonableChart');
            if (!charts.cwltReasonableChart) {
                charts.cwltReasonableChart = echarts.init(chartDom);
            }

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}件 ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        type: 'pie',
                        radius: '60%',
                        data: [
                            { value: cwltStats['合理'], name: '合理', itemStyle: { color: '#67c23a' } },
                            { value: cwltStats['不合理'], name: '不合理', itemStyle: { color: '#f56c6c' } },
                            { value: cwltStats['待确认'], name: '待确认', itemStyle: { color: '#e6a23c' } }
                        ]
                    }
                ]
            };

            charts.cwltReasonableChart.setOption(option);

            // CW_LT不合理项金额影响
            const unreasonableAmount = data
                .filter(item => (item.CW_LT是否合理 || '').includes('不合理'))
                .reduce((sum, item) => sum + (parseFloat(item.呆滞总金额) || 0), 0);

            const totalAmount = data.reduce((sum, item) => sum + (parseFloat(item.呆滞总金额) || 0), 0);
            const reasonableAmount = totalAmount - unreasonableAmount;

            const chartDom2 = safeGetElement('cwltImpactChart');
            if (!charts.cwltImpactChart) {
                charts.cwltImpactChart = echarts.init(chartDom2);
            }

            const option2 = {
                tooltip: {
                    trigger: 'item',
                    formatter: params => `${params.name}<br/>金额: ¥${(params.value / 10000).toFixed(2)}万<br/>占比: ${params.percent}%`
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        type: 'pie',
                        radius: ['40%', '70%'],
                        data: [
                            { value: reasonableAmount, name: 'CW_LT合理金额', itemStyle: { color: '#67c23a' } },
                            { value: unreasonableAmount, name: 'CW_LT不合理金额', itemStyle: { color: '#f56c6c' } }
                        ],
                        label: {
                            formatter: '{b}\n¥{c}'
                        }
                    }
                ]
            };

            charts.cwltImpactChart.setOption(option2);
        }

        // 7. 智能预警
        function updateSmartAlerts(data) {
            // 高风险零件（金额>100万 且有不合理项）
            const highRiskItems = data.filter(item => {
                const amount = parseFloat(item.呆滞总金额) || 0;
                const priceUnreasonable = (item.单价是否合理 || '').includes('不合理');
                const cwltUnreasonable = (item.CW_LT是否合理 || '').includes('不合理');
                return amount > 1000000 && (priceUnreasonable || cwltUnreasonable);
            }).sort((a, b) => (parseFloat(b.呆滞总金额) || 0) - (parseFloat(a.呆滞总金额) || 0)).slice(0, 5);

            let highRiskHtml = '';
            if (highRiskItems.length === 0) {
                highRiskHtml = '<div class="alert alert-success">暂无高风险项</div>';
            } else {
                highRiskItems.forEach(item => {
                    highRiskHtml += `<div class="alert alert-danger alert-sm">
                        <strong>${item.T1零部件名称}</strong><br/>
                        金额: ¥${((parseFloat(item.呆滞总金额) || 0) / 10000).toFixed(2)}万<br/>
                        ${(item.单价是否合理 || '').includes('不合理') ? '⚠️ 单价不合理 ' : ''}
                        ${(item.CW_LT是否合理 || '').includes('不合理') ? '⚠️ CW_LT不合理' : ''}
                    </div>`;
                });
            }
            document.getElementById('highRiskList').innerHTML = highRiskHtml;

            // 长期呆滞预警（LT > 12个月）
            const longTermItems = data.filter(item => (parseFloat(item.LT) || 0) > 12)
                .sort((a, b) => (parseFloat(b.LT) || 0) - (parseFloat(a.LT) || 0))
                .slice(0, 5);

            let longTermHtml = '';
            if (longTermItems.length === 0) {
                longTermHtml = '<div class="alert alert-success">暂无长期呆滞项</div>';
            } else {
                longTermItems.forEach(item => {
                    longTermHtml += `<div class="alert alert-warning alert-sm">
                        <strong>${item.T1零部件名称}</strong><br/>
                        LT: ${(parseFloat(item.LT) || 0).toFixed(1)}个月<br/>
                        金额: ¥${((parseFloat(item.呆滞总金额) || 0) / 10000).toFixed(2)}万
                    </div>`;
                });
            }
            document.getElementById('longTermList').innerHTML = longTermHtml;

            // 集中度风险（单一供应商占比>20%）
            const supplierStats = {};
            const totalAmount = data.reduce((sum, item) => sum + (parseFloat(item.呆滞总金额) || 0), 0);

            data.forEach(item => {
                const supplier = item.T1供应商名称 || '未知';
                const amount = parseFloat(item.呆滞总金额) || 0;
                supplierStats[supplier] = (supplierStats[supplier] || 0) + amount;
            });

            const concentrationRisks = Object.entries(supplierStats)
                .map(([name, amount]) => ({ name, amount, ratio: (amount / totalAmount * 100).toFixed(1) }))
                .filter(item => item.ratio > 20)
                .sort((a, b) => b.ratio - a.ratio);

            let concentrationHtml = '';
            if (concentrationRisks.length === 0) {
                concentrationHtml = '<div class="alert alert-success">暂无集中度风险</div>';
            } else {
                concentrationRisks.forEach(item => {
                    concentrationHtml += `<div class="alert alert-info alert-sm">
                        <strong>${item.name}</strong><br/>
                        占比: ${item.ratio}%<br/>
                        金额: ¥${(item.amount / 10000).toFixed(2)}万
                    </div>`;
                });
            }
            document.getElementById('concentrationRiskList').innerHTML = concentrationHtml;
        }

        // Removed: 项目对比分析 (obsolete)

        // 9. Excel导出功能
        function exportToExcel() {
            let data = [];
            if (currentSheet === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[currentSheet] || [];
            }

            // 应用当前筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            // 准备导出数据
            const exportData = data.map(item => ({
                '工作表': currentSheet,
                '呆滞金额': item.呆滞金额,
                '分类': item.分类,
                'PSM专业组': item.PSM专业组,
                'PSM': item.PSM,
                '零件类型': item.零件类型,
                'T1物料编码': item.T1物料编码,
                'T1零部件名称': item.T1零部件名称,
                'T1供应商编码': item.T1供应商编码,
                'T1供应商名称': item.T1供应商名称,
                'Tn零部件品类': item.Tn零部件品类,
                '是否EOP': item.是否EOP,
                'LT': item.LT,
                'CW': item.CW,
                '是否认可为行业内理想专用': item.是否认可为行业内理想专用,
                '单价是否合理': item.单价是否合理,
                'CW_LT是否合理': item.CW_LT是否合理,
                '理想端呆滞数量': item.理想端呆滞数量,
                'T1端呆滞数量': item.T1端呆滞数量,
                '理想端呆滞金额': item.理想端呆滞金额,
                'T1端呆滞金额': item.T1端呆滞金额,
                '呆滞总金额': item.呆滞总金额,
                '呆滞总数量': item.呆滞总数量,
                '下一步措施': item.下一步措施,
                '内部review': item.内部review
            }));

            // 创建工作簿
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "EOP数据");

            // 下载文件
            const fileName = `EOP呆滞数据_${currentSheet}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            alert(`Excel文件已导出: ${fileName}`);
        }

        // ========== CW/LT 分布图分析功能 ==========

        // 初始化分布图选项
        function updateDistributionOptions(data) {
            // 更新PSM专业组选项
            const psmSelect = document.getElementById('distPSM');
            const psmSet = new Set();
            data.forEach(item => {
                if (item.PSM专业组) psmSet.add(item.PSM专业组);
            });

            const currentPSM = psmSelect.value;
            psmSelect.innerHTML = '<option value="">--全部--</option>';
            Array.from(psmSet).sort().forEach(psm => {
                const option = document.createElement('option');
                option.value = psm;
                option.textContent = psm;
                if (psm === currentPSM) option.selected = true;
                psmSelect.appendChild(option);
            });

            // 更新Tn零部件品类选项
            const categorySelect = safeGetElement('distCategory');
            if (categorySelect) { // v2.3.7: 防御性检查
                const categorySet = new Set();
                data.forEach(item => {
                    if (item.Tn零部件品类) categorySet.add(item.Tn零部件品类);
                });

                const currentCategory = categorySelect.value;
                categorySelect.innerHTML = '<option value="">--全部--</option>';
                Array.from(categorySet).sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    if (category === currentCategory) option.selected = true;
                    categorySelect.appendChild(option);
                });
            }

            // 初始更新零件选项
            updateDistParts();
        }

        // 更新零件选项（关联PSM专业组）
        function updateDistParts() {
            let data = [];
            const sheetFilterElement = document.getElementById('distSheet');
            const sheetFilter = sheetFilterElement ? sheetFilterElement.value : currentSheet;

            if (sheetFilter === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[sheetFilter] || [];
            }

            // 应用阶梯和类型筛选
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = document.getElementById('distPSM').value;
            const partSelect = document.getElementById('distPart');
            const partSet = new Set();

            // 如果选择了PSM专业组，只显示该组的零件
            if (selectedPSM) {
                data.filter(item => item.PSM专业组 === selectedPSM).forEach(item => {
                    if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                        partSet.add(item.T1零部件名称);
                    }
                });
            } else {
                // 显示所有零件
                data.forEach(item => {
                    if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                        partSet.add(item.T1零部件名称);
                    }
                });
            }

            const currentPart = partSelect.value;
            partSelect.innerHTML = '<option value="">--全部--</option>';
            Array.from(partSet).sort().forEach(part => {
                const option = document.createElement('option');
                option.value = part;
                option.textContent = part;
                if (part === currentPart) option.selected = true;
                partSelect.appendChild(option);
            });
        }

        // 更新分布图
        function updateDistribution() {
            let data = [];
            const sheetFilter = safeGetValue('distSheet', currentSheet); // v2.3.7: 使用安全访问和fallback

            if (sheetFilter === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[sheetFilter] || [];
            }

            // 应用所有筛选条件
            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = safeGetValue('distPSM'); // v2.3.7: 安全访问
            const selectedPart = safeGetValue('distPart'); // v2.3.7: 安全访问
            const selectedCategory = safeGetValue('distCategory'); // v2.3.7: 安全访问
            const ltMin = parseFloat(safeGetValue('distLTMin')) || 0;
            const ltMax = parseFloat(safeGetValue('distLTMax')) || 100;
            const cwMin = parseFloat(safeGetValue('distCWMin')) || 0;
            const cwMax = parseFloat(safeGetValue('distCWMax')) || 100;

            // 应用筛选
            let filteredData = data.filter(item => {
                if (selectedPSM && item.PSM专业组 !== selectedPSM) return false;
                if (selectedPart && item.T1零部件名称 !== selectedPart) return false;
                if (selectedCategory && item.Tn零部件品类 !== selectedCategory) return false;
                if (item.LT < ltMin || item.LT > ltMax) return false;
                if (item.CW < cwMin || item.CW > cwMax) return false;
                return true;
            });

            // 更新统计摘要
            const config = getMetricConfig();
            const totalAmount = filteredData.reduce((sum, item) => sum + getMetricValue(item, 'total'), 0);
            const ltValues = filteredData.map(item => item.LT).filter(v => v > 0);
            const cwValues = filteredData.map(item => item.CW).filter(v => v > 0);

            const ltAvg = ltValues.length > 0 ? ltValues.reduce((a, b) => a + b, 0) / ltValues.length : 0;
            const cwAvg = cwValues.length > 0 ? cwValues.reduce((a, b) => a + b, 0) / cwValues.length : 0;

            // v2.3.11: 计算中位值
            const calculateMedian = (values) => {
                if (values.length === 0) return 0;
                const sorted = [...values].sort((a, b) => a - b);
                return sorted.length % 2 === 0
                    ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
                    : sorted[Math.floor(sorted.length / 2)];
            };
            const ltMedian = calculateMedian(ltValues);
            const cwMedian = calculateMedian(cwValues);

            document.getElementById('distSummary').innerHTML = `
                <strong>筛选结果：</strong>共 ${filteredData.length} 条记录 |
                呆滞金额：${config.displayFormatter(totalAmount)} |
                LT平均：${ltAvg.toFixed(2)}月，中位值：${ltMedian.toFixed(2)}月 |
                CW平均：${cwAvg.toFixed(2)}月，中位值：${cwMedian.toFixed(2)}月
            `;

            // 绘制LT分布图（按2周区间）
            updateDistributionChart('LT', ltValues, 'distChartLT');

            // 绘制CW分布图（按2周区间）
            updateDistributionChart('CW', cwValues, 'distChartCW');

            // 更新明细列表
            updateDistributionTable(filteredData);
        }

        // v2.3.7: Wrapper function for HTML onchange events that call updateDistributionAnalysis
        function updateDistributionAnalysis() {
            updateDistribution();
        }

        // 绘制分布图（按2周区间）
        function updateDistributionChart(type, values, chartId) {
            const chartDom = safeGetElement(chartId); // v2.3.8
            if (!chartDom) return; // v2.3.8
            if (!charts[chartId]) {
                charts[chartId] = echarts.init(chartDom);
            }

            if (values.length === 0) {
                charts[chartId].clear();
                return;
            }

            // 计算统计值
            const sortedValues = [...values].sort((a, b) => a - b);
            const median = sortedValues.length % 2 === 0
                ? (sortedValues[sortedValues.length / 2 - 1] + sortedValues[sortedValues.length / 2]) / 2
                : sortedValues[Math.floor(sortedValues.length / 2)];
            const average = values.reduce((a, b) => a + b, 0) / values.length;

            // 按2周（0.5月）进行分组
            const binSize = 0.5; // 0.5月 = 2周
            const maxValue = Math.max(...values);
            const binCount = Math.ceil(maxValue / binSize);

            const bins = new Array(binCount).fill(0);
            const binLabels = [];

            // 统计每个区间的数量
            values.forEach(value => {
                const binIndex = Math.min(Math.floor(value / binSize), binCount - 1);
                bins[binIndex]++;
            });

            // 生成区间标签
            for (let i = 0; i < binCount; i++) {
                const start = (i * binSize).toFixed(1);
                const end = ((i + 1) * binSize).toFixed(1);
                binLabels.push(`${start}-${end}`);
            }

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        let result = params[0].name + '月<br/>' +
                                   '数量: ' + params[0].value + '条<br/>' +
                                   '<span style="color:#5470c6">━━</span> 平均值: ' + average.toFixed(2) + '月<br/>' +
                                   '<span style="color:#ee6666">┄┄</span> 中位值: ' + median.toFixed(2) + '月';
                        return result;
                    }
                },
                legend: {
                    data: ['分布', '平均值', '中位值'],
                    top: 10
                },
                grid: { left: '10%', right: '5%', bottom: '15%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: binLabels,
                    name: type + '(月)',
                    nameLocation: 'center',
                    nameGap: 30,
                    axisLabel: {
                        rotate: 45,
                        interval: Math.floor(binCount / 10) // 防止标签过密
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '数量(条)'
                },
                series: [{
                    name: '分布', // v2.3.11: 添加name以便legend显示
                    type: 'bar',
                    data: bins,
                    itemStyle: {
                        color: type === 'LT' ?
                            new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#83bff6' },
                                { offset: 1, color: '#188df0' }
                            ]) :
                            new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#fccb05' },
                                { offset: 1, color: '#f77062' }
                            ])
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function(params) {
                            return params.value > 0 ? params.value : '';
                        }
                    },
                    markLine: {
                        data: [
                            {
                                name: '平均值',
                                xAxis: Math.floor(average / binSize),
                                lineStyle: {
                                    color: '#5470c6',
                                    type: 'solid',
                                    width: 2
                                },
                                label: {
                                    formatter: '平均: ' + average.toFixed(2) + '月',
                                    position: 'end'
                                }
                            },
                            {
                                name: '中位值',
                                xAxis: Math.floor(median / binSize),
                                lineStyle: {
                                    color: '#ee6666',
                                    type: 'dashed',
                                    width: 2
                                },
                                label: {
                                    formatter: '中位: ' + median.toFixed(2) + '月',
                                    position: 'end'
                                }
                            }
                        ]
                    }
                }]
            };

            charts[chartId].setOption(option);
        }

        // 更新明细列表
        function updateDistributionTable(data) {
            const table = safeGetElement('distTable');
            if (!table) return; // v2.3.7.2: 防御性检查

            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            // 获取排序方式
            const sortElement = document.querySelector('input[name="distSort"]:checked');
            const sortBy = sortElement ? sortElement.value : 'LT'; // v2.3.7.2: fallback

            // 排序
            let sortedData = [...data];
            if (sortBy === 'LT') {
                sortedData.sort((a, b) => b.LT - a.LT);
            } else if (sortBy === 'CW') {
                sortedData.sort((a, b) => b.CW - a.CW);
            } else if (sortBy === 'amount') {
                sortedData.sort((a, b) => getMetricValue(b, 'total') - getMetricValue(a, 'total'));
            }

            const config = getMetricConfig();

            // 显示所有结果（如果太多可以限制）
            const displayLimit = 500;
            sortedData.slice(0, displayLimit).forEach((item, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.PSM专业组 || '-';
                row.insertCell(2).textContent = item.T1零部件名称 || '-';
                row.insertCell(3).textContent = item.T1物料编码 || '-';
                row.insertCell(4).textContent = item.T1供应商名称 || '-';
                row.insertCell(5).textContent = item.Tn零部件品类 || '-';
                row.insertCell(6).textContent = item.LT ? item.LT.toFixed(2) : '-';
                row.insertCell(7).textContent = item.CW ? item.CW.toFixed(2) : '-';
                row.insertCell(8).textContent = config.displayFormatter(getMetricValue(item, 'total'));
            });

            if (sortedData.length > displayLimit) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = `显示前${displayLimit}条，共${sortedData.length}条记录`;
            }

            if (sortedData.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 9;
                cell.className = 'text-center text-muted';
                cell.textContent = '没有符合条件的数据';
            }
        }

        // ========== CW标准对比分析功能 ==========

        // 初始化CW标准分析选项
        function updateCWStandardOptions(data) {
            // 更新PSM专业组选项
            const psmSelect = safeGetElement('cwStdPSM'); // v2.3.7.3
            if (!psmSelect) return; // v2.3.7.3: 防御性检查

            const psmSet = new Set();
            data.forEach(item => {
                if (item.PSM专业组) psmSet.add(item.PSM专业组);
            });

            const currentPSM = psmSelect.value;
            psmSelect.innerHTML = '<option value="">--全部--</option>';
            Array.from(psmSet).sort().forEach(psm => {
                const option = document.createElement('option');
                option.value = psm;
                option.textContent = psm;
                if (psm === currentPSM) option.selected = true;
                psmSelect.appendChild(option);
            });

            updateCWStdParts();
        }

        // 更新零件选项（关联PSM专业组）
        function updateCWStdParts() {
            let data = [];
            const sheetFilter = safeGetValue('cwStdSheet');

            if (sheetFilter === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[sheetFilter] || [];
            }

            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = safeGetValue('cwStdPSM');
            const partSelect = document.getElementById('cwStdPart');
            const partSet = new Set();

            if (selectedPSM) {
                data.filter(item => item.PSM专业组 === selectedPSM).forEach(item => {
                    if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                        partSet.add(item.T1零部件名称);
                    }
                });
            } else {
                data.forEach(item => {
                    if (item.T1零部件名称 && item.T1零部件名称.trim() !== '') {
                        partSet.add(item.T1零部件名称);
                    }
                });
            }

            const currentPart = partSelect.value;
            partSelect.innerHTML = '<option value="">--全部--</option>';
            Array.from(partSet).sort().forEach(part => {
                const option = document.createElement('option');
                option.value = part;
                option.textContent = part;
                if (part === currentPart) option.selected = true;
                partSelect.appendChild(option);
            });
        }

        // CW标准匹配算法
        function matchCWStandard(tnCategory, matchMode = 'auto') {
            if (!tnCategory || tnCategory.trim() === '') return null;

            const category = tnCategory.trim();

            // 精确匹配：直接匹配中品类
            for (const std of CW_STANDARDS) {
                if (std.中品类 === category) {
                    return std;
                }
            }

            // 模糊匹配：包含关系
            if (matchMode === 'fuzzy' || matchMode === 'auto') {
                // 先尝试Tn品类包含标准中品类
                for (const std of CW_STANDARDS) {
                    if (category.includes(std.中品类)) {
                        return std;
                    }
                }

                // 再尝试标准中品类或小类包含Tn品类
                for (const std of CW_STANDARDS) {
                    if (std.中品类.includes(category) || (std.小类 && std.小类.includes(category))) {
                        return std;
                    }
                }

                // 关键词匹配
                const keywords = ['电池', '摄像头', '屏幕', '电机', '芯片', '传感器', '处理器',
                                '电容', '电感', '电阻', '晶振', '二极管', '三极管', 'IGBT', 'MOSFET',
                                '塑料', '橡胶', '金属', '铝', '钢', '铜', '玻璃', '陶瓷', '线束'];

                for (const keyword of keywords) {
                    if (category.includes(keyword)) {
                        for (const std of CW_STANDARDS) {
                            if (std.中品类.includes(keyword) || (std.小类 && std.小类.includes(keyword))) {
                                return std;
                            }
                        }
                    }
                }
            }

            return null;
        }

        // CW标准对比分析主函数
        function updateCWStandardAnalysis() {
            let data = [];
            const sheetFilter = safeGetValue('cwStdSheet');

            if (sheetFilter === 'ALL') {
                data = [...allData.L987, ...allData.L6];
            } else {
                data = allData[sheetFilter] || [];
            }

            const selectedTiers = Array.from(document.querySelectorAll('.tier-checkbox:checked')).map(cb => cb.value);
            if (selectedTiers.length > 0) {
                data = data.filter(item => selectedTiers.includes(item.分类));
            }

            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.value);
            if (selectedTypes.length > 0) {
                data = data.filter(item => {
                    const partType = item.零件类型 || '';
                    if (selectedTypes.includes('总成') && partType.includes('总成')) return true;
                    if (selectedTypes.includes('物料') && !partType.includes('总成')) return true;
                    return false;
                });
            }

            const selectedPSM = safeGetValue('cwStdPSM');
            const selectedPart = safeGetValue('cwStdPart');
            const matchMode = safeGetValue('cwStdMatchMode');

            if (selectedPSM) {
                data = data.filter(item => item.PSM专业组 === selectedPSM);
            }
            if (selectedPart) {
                data = data.filter(item => item.T1零部件名称 === selectedPart);
            }

            // 为每条数据匹配CW标准
            const enrichedData = data.map(item => {
                const matched = matchCWStandard(item.Tn零部件品类, matchMode);
                const actualCWDays = item.CW * 30; // 转换为天数

                let standardCW = null;
                let exceeded = false;
                let exceededDays = 0;

                if (matched) {
                    // 优先使用国产标准，如果没有则使用进口标准
                    standardCW = matched.国产CW || matched.进口CW;

                    if (standardCW && actualCWDays > standardCW) {
                        exceeded = true;
                        exceededDays = actualCWDays - standardCW;
                    }
                }

                return {
                    ...item,
                    matchedStandard: matched,
                    standardCW: standardCW,
                    actualCWDays: actualCWDays,
                    exceeded: exceeded,
                    exceededDays: exceededDays
                };
            });

            // 统计数据
            const totalCount = enrichedData.length;
            const matchedCount = enrichedData.filter(item => item.matchedStandard).length;
            const exceededCount = enrichedData.filter(item => item.exceeded).length;
            const exceededRate = matchedCount > 0 ? (exceededCount / matchedCount * 100).toFixed(1) : 0;

            // 更新统计卡片
            safeSetTextContent('cwStdTotalCount', totalCount.toLocaleString());
            safeSetTextContent('cwStdMatchedCount', matchedCount.toLocaleString());
            safeSetTextContent('cwStdExceededCount', exceededCount.toLocaleString());
            safeSetTextContent('cwStdExceededRate', exceededRate + '%');

            // 更新图表
            updateCWStandardCharts(enrichedData);

            // 更新列表
            updateCWStandardTable(enrichedData);
        }

        // 更新CW标准对比图表
        function updateCWStandardCharts(data) {
            // 按中品类统计超标情况
            const categoryStats = {};
            data.forEach(item => {
                if (!item.matchedStandard) return;

                const category = item.matchedStandard.中品类;
                if (!categoryStats[category]) {
                    categoryStats[category] = { total: 0, exceeded: 0 };
                }
                categoryStats[category].total++;
                if (item.exceeded) {
                    categoryStats[category].exceeded++;
                }
            });

            // 图表1: 按中品类的超标分布（雷达图）
            const categoryChartDom = safeGetElement('cwStdCategoryChart'); // v2.3.7
            if (categoryChartDom && !charts.cwStdCategoryChart) {
                charts.cwStdCategoryChart = echarts.init(categoryChartDom);
            }

            if (charts.cwStdCategoryChart) { // v2.3.7: 只在图表存在时更新

            const sortedCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1].exceeded - a[1].exceeded)
                .slice(0, 8); // 雷达图取前8个品类

            // 计算最大值用于雷达图刻度
            const maxTotal = Math.max(...sortedCategories.map(item => item[1].total));
            const maxExceeded = Math.max(...sortedCategories.map(item => item[1].exceeded));

            const categoryOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const category = sortedCategories[params.dataIndex];
                        return `${category[0]}<br/>` +
                               `总数: ${category[1].total}条<br/>` +
                               `超标: ${category[1].exceeded}条<br/>` +
                               `超标率: ${(category[1].exceeded / category[1].total * 100).toFixed(1)}%`;
                    }
                },
                legend: {
                    data: ['总数', '超标数', '超标率'],
                    bottom: 0
                },
                radar: {
                    indicator: sortedCategories.map(item => ({
                        name: item[0],
                        max: maxTotal
                    })),
                    radius: '60%',
                    splitNumber: 4
                },
                series: [{
                    type: 'radar',
                    data: [
                        {
                            value: sortedCategories.map(item => item[1].total),
                            name: '总数',
                            areaStyle: {
                                color: 'rgba(145, 204, 117, 0.3)'
                            },
                            lineStyle: { color: '#91cc75', width: 2 }
                        },
                        {
                            value: sortedCategories.map(item => item[1].exceeded),
                            name: '超标数',
                            areaStyle: {
                                color: 'rgba(238, 102, 102, 0.3)'
                            },
                            lineStyle: { color: '#ee6666', width: 2 }
                        }
                    ]
                }]
            };

            charts.cwStdCategoryChart.setOption(categoryOption);
            } // v2.3.7: 结束图表存在性检查

            // 图表2: 超标程度分析（分段统计）
            const exceedChartDom = safeGetElement('cwStdExceedChart'); // v2.3.7
            if (exceedChartDom && !charts.cwStdExceedChart) {
                charts.cwStdExceedChart = echarts.init(exceedChartDom);
            }

            if (charts.cwStdExceedChart) { // v2.3.7: 只在图表存在时更新

            const exceedRanges = {
                '未超标': 0,
                '超标1-30天': 0,
                '超标31-60天': 0,
                '超标61-90天': 0,
                '超标90天以上': 0
            };

            data.forEach(item => {
                if (!item.matchedStandard) return;

                if (!item.exceeded) {
                    exceedRanges['未超标']++;
                } else if (item.exceededDays <= 30) {
                    exceedRanges['超标1-30天']++;
                } else if (item.exceededDays <= 60) {
                    exceedRanges['超标31-60天']++;
                } else if (item.exceededDays <= 90) {
                    exceedRanges['超标61-90天']++;
                } else {
                    exceedRanges['超标90天以上']++;
                }
            });

            const exceedOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c}条 ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: Object.entries(exceedRanges).map(([name, value]) => ({
                        name: name,
                        value: value
                    })),
                    label: {
                        formatter: '{b}\n{c}条'
                    }
                }]
            };

            charts.cwStdExceedChart.setOption(exceedOption);
            } // v2.3.7: 结束图表存在性检查
        }

        // 更新CW标准对比列表
        function updateCWStandardTable(data) {
            const table = safeGetElement('cwStdTable'); // v2.3.7
            if (!table) return;

            const tbody = table.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const filter = document.querySelector('input[name="cwStdFilter"]:checked').value;

            let filteredData = data;
            if (filter === 'matched') {
                filteredData = data.filter(item => item.matchedStandard);
            } else if (filter === 'exceeded') {
                filteredData = data.filter(item => item.exceeded);
            } else if (filter === 'unmatched') {
                filteredData = data.filter(item => !item.matchedStandard);
            }

            const config = getMetricConfig();

            filteredData.slice(0, 500).forEach((item, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = item.PSM专业组 || '-';
                row.insertCell(2).textContent = item.T1零部件名称 || '-';
                row.insertCell(3).textContent = item.Tn零部件品类 || '-';
                row.insertCell(4).textContent = item.actualCWDays ? item.actualCWDays.toFixed(1) : '-';

                const matchedCell = row.insertCell(5);
                if (item.matchedStandard) {
                    matchedCell.textContent = item.matchedStandard.中品类;
                    matchedCell.style.color = '#52c41a';
                } else {
                    matchedCell.textContent = '未匹配';
                    matchedCell.style.color = '#999';
                }

                row.insertCell(6).textContent = item.standardCW ? item.standardCW.toFixed(0) : '-';

                const exceededCell = row.insertCell(7);
                if (item.exceeded) {
                    exceededCell.textContent = '+' + item.exceededDays.toFixed(1);
                    exceededCell.style.color = '#ff4d4f';
                    exceededCell.style.fontWeight = 'bold';
                } else if (item.matchedStandard) {
                    exceededCell.textContent = '合格';
                    exceededCell.style.color = '#52c41a';
                } else {
                    exceededCell.textContent = '-';
                }

                const statusCell = row.insertCell(8);
                if (item.exceeded) {
                    statusCell.innerHTML = '<span class="badge bg-danger">超标</span>';
                } else if (item.matchedStandard) {
                    statusCell.innerHTML = '<span class="badge bg-success">正常</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge bg-secondary">未匹配</span>';
                }

                row.insertCell(9).textContent = config.displayFormatter(getMetricValue(item, 'total'));
            });

            if (filteredData.length > 500) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 10;
                cell.className = 'text-center text-muted';
                cell.textContent = `显示前500条，共${filteredData.length}条记录`;
            }

            if (filteredData.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 10;
                cell.className = 'text-center text-muted';
                cell.textContent = '没有符合条件的数据';
            }
        }
    </script>
</body>
</html>
